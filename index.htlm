<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: GitHub Drafter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #FFE81F; /* SW Yellow */
            --text-main: #e0e0e0;
            
            /* SWU Aspect Colors */
            --c-Aggression: #bd1e2d; 
            --c-Command: #377d22;    
            --c-Cunning: #f2c035;    
            --c-Vigilance: #006eb6;  
            --c-Villainy: #222222;   
            --c-Heroism: #eeeeee;    

            /* Types */
            --c-leader: #fff; --c-base: #aaa; --c-unit: #444; --c-pool: #402020; 
            --success-green: #0a0;
        }

        body { background: var(--bg); color: var(--text-main); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { padding: 10px 20px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; height: 50px; z-index: 10; }
        h1 { margin: 0; font-family: 'Orbitron'; color: var(--accent); font-size: 18px; letter-spacing: 1px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        
        select, input { background: #111; color: var(--accent); border: 1px solid #444; padding: 5px 10px; font-family: 'Orbitron'; font-size: 14px; border-radius: 4px; }
        input { width: 50px; text-align: center; }
        
        button.btn { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; font-family: 'Orbitron'; cursor: pointer; transition: 0.2s; border-radius: 4px; font-size: 12px; text-transform: uppercase; }
        button.btn:hover { border-color: var(--accent); color: var(--accent); background: #000; }
        button.btn:disabled { color: #555; border-color: #333; cursor: wait; opacity: 0.7; }
        
        button.btn-pew { background: #822; border-color: #a44; color: #fff; font-weight: bold; }
        button.btn-pew:hover { background: #b33; border-color: #f66; color: #fff; transform: scale(1.1); }

        .stat { font-family: 'Orbitron'; font-size: 14px; color: #aaa; margin-right: 20px; }
        .stat span { color: var(--accent); }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; position: relative; }
        #board { flex: 1; display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat; align-items: flex-start; }
        #board::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: -1; pointer-events: none; }

        /* --- COLUMNS --- */
        .column { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; transition: all 0.2s; flex-shrink: 0; height: 100%; min-width: 150px; width: 150px; }
        .column.drag-over { background: rgba(60, 60, 60, 0.95); box-shadow: 0 0 25px var(--accent); border-color: var(--accent); }
        .col-special { width: 170px; min-width: 170px; border: 1px solid #555; }
        
        /* RETTET: Mindre Pool (340px) */
        .col-pool { width: 340px; min-width: 340px; border: 1px solid #644; background: rgba(30, 20, 20, 0.9); }

        .col-header { padding: 8px; text-align: center; font-family: 'Orbitron'; font-weight: bold; font-size: 16px; border-bottom: 4px solid transparent; text-transform: uppercase; background: rgba(0,0,0,0.6); border-top-left-radius: 8px; border-top-right-radius: 8px; z-index: 5; }
        
        /* Header Colors */
        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); }
        .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); }
        .ch-Pool { border-bottom-color: var(--c-pool); color: #faa; }
        .ch-cost { border-bottom-color: var(--c-unit); color: #fff; font-size: 20px; }
        .ch-Aggression { border-bottom-color: var(--c-Aggression); color: var(--c-Aggression); }
        .ch-Command { border-bottom-color: var(--c-Command); color: var(--c-Command); }
        .ch-Cunning { border-bottom-color: var(--c-Cunning); color: var(--c-Cunning); }
        .ch-Vigilance { border-bottom-color: var(--c-Vigilance); color: var(--c-Vigilance); }
        .ch-Villainy { border-bottom-color: var(--c-Villainy); color: #999; }
        .ch-Heroism { border-bottom-color: var(--c-Heroism); color: #fff; }

        .col-content { flex: 1; overflow-y: auto; overflow-x: visible; padding: 15px 10px 50px 10px; display: flex; flex-direction: column; align-items: center; }
        #list-Pool { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; align-items: start; }

        /* --- SIDEBAR --- */
        #sidebar { width: 280px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 100; transition: all 0.2s; position: relative; flex-shrink: 0; }
        #sidebar.drag-over-deck { background: #1a1a1a; box-shadow: inset 0 0 20px var(--success-green); border-left: 2px solid var(--success-green); }
        .sb-header { padding: 15px; background: #181818; border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); }
        #deck-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        #deck-list li { background: #222; padding: 6px 10px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; font-size: 13px; border-radius: 3px; cursor: pointer; transition: background 0.2s; }
        #deck-list li:hover { background: #444; color: #fff; }
        .sb-footer { padding: 10px; border-top: 1px solid #333; background: #181818; }

        /* --- CARD ITEM (Optimized for performance) --- */
        .card-item { 
            position: relative; background: #000; border-radius: 6px; cursor: grab; 
            box-shadow: 0 -2px 5px rgba(0,0,0,0.5); 
            transition: transform 0.1s ease-out, margin 0.2s; 
            display: flex; flex-direction: column; width: 100%; z-index: 1; 
            will-change: transform; /* Performance Boost */
        }
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) { margin-top: -135px; }
        #list-Pool .card-item, #list-Leader .card-item, #list-Base .card-item { margin-top: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.6); }
        
        .card-item:hover { 
            transform: scale(1.25) translateY(-10px); /* Lidt mindre scale for at undgå flimmer */
            z-index: 1000 !important; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); 
            border: 1px solid var(--accent); 
        }
        .card-item img { width: 100%; height: auto; display: block; border-radius: 6px; pointer-events: none; }

        .card-actions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; border-radius: 6px; }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 24px; color: #fff; font-weight: bold; pointer-events: none; background: rgba(0,0,0,0.6); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; }
        .stack-badge { position: absolute; top: 5px; right: 5px; background: var(--accent); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: 900; border: 2px solid #000; z-index: 5; box-shadow: 2px 2px 5px #000; }

        /* --- LOADING STATUS --- */
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; }

        /* --- TOOLTIPS & MODALS --- */
        #preview-tooltip { position: fixed; display: none; z-index: 5000; pointer-events: none; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; }
        #preview-tooltip img { width: 320px; display: block; }
        #preview-tooltip.big-preview img { width: auto; height: 60vh; max-width: none; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
        #modal img { max-width:90vw; max-height:70vh; border-radius: 10px; display: block; box-shadow: 0 0 50px #000; border: 2px solid #333; }
        .big-flip-btn { background: var(--accent); color: #000; font-family: 'Orbitron'; font-size: 24px; font-weight: 900; padding: 15px 40px; border: 3px solid #000; border-radius: 8px; cursor: pointer; box-shadow: 0 0 20px var(--accent); margin-top: 20px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h1 style="color:var(--accent); font-family:'Orbitron'">STARTER SYSTEM</h1>
        <p id="loading-text" style="font-family:'Rajdhani'; font-size:18px; color:#ccc;">Leder efter swu_komplet_database.csv...</p>
    </div>

    <header>
        <div class="controls">
            <h1>SWU Drafter</h1>
            <select id="setSelect">
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="SEC">Secrets of Power (SEC)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
            </select>
            
            <label style="color:#aaa; font-size:12px; margin-left:10px;">Pakker:</label>
            <input type="number" id="packCount" value="6" min="1" max="24">
            <button class="btn" id="btn-open" onclick="openPacks()">ÅBN</button>
            
            <button class="btn" id="btn-toggle-lb" onclick="toggleLeadersBases()">Skjul L/B</button>
            <button class="btn" id="btn-sort" onclick="toggleSort()">Sorter: Cost</button>
            <button class="btn btn-pew" onclick="playAudio('snd-pew')">PEW PEW!</button>
        </div>
        <div id="stats">
            <span class="stat">Pool: <span id="s-total">0</span></span>
        </div>
    </header>

    <div id="main-area">
        <div id="board"></div>
        <div id="sidebar">
            <div class="sb-header">Dit Deck (<span id="deck-count">0</span>)</div>
            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <button class="btn" style="width:100%" onclick="copyJSON()">Kopiér JSON</button>
                <button class="btn" style="width:100%; margin-top:5px; background:#4a1a1a; border-color:#6a2a2a;" onclick="clearDeck()">Slet Deck</button>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-card-container" onclick="flipLeader(event)">
            <img id="modal-img">
        </div>
        <button id="modal-flip-btn" class="big-flip-btn" onclick="flipLeader(event)">VEND LEADER ↻</button>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">Kopieret!</div>
    
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-pew" src="https://www.myinstants.com/media/sounds/pew-pew-pew-pew-pew.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>

<script>
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism"];
let myDeck = {}, currentView = [], areSpecialColsVisible = true, currentSortMode = 'cost';
let LOCAL_DATABASE = {};

// --- AUTO LOAD CSV (GitHub Mode) ---
window.onload = function() {
    fetch('swu_komplet_database.csv')
        .then(response => {
            if (!response.ok) throw new Error("Fil ikke fundet");
            return response.text();
        })
        .then(data => {
            parseCSVandInstall(data);
        })
        .catch(err => {
            console.warn(err);
            // Hvis fetch fejler (f.eks. lokalt uden server), tjek localStorage
            const storedDB = localStorage.getItem('SWU_DB');
            if (storedDB) {
                LOCAL_DATABASE = JSON.parse(storedDB);
                document.getElementById('loading-overlay').style.display = 'none';
                initBoard();
            } else {
                document.getElementById('loading-text').innerHTML = 
                    "Kunne ikke finde 'swu_komplet_database.csv' automatisk.<br>Sørg for filen ligger i samme mappe, eller kør dette på en server (GitHub Pages).<br><br><input type='file' onchange='handleFileSelect(this.files)'>";
            }
        });
};

function handleFileSelect(files) {
    if(!files || !files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) { parseCSVandInstall(e.target.result); };
    reader.readAsText(files[0]);
}

function parseCSVandInstall(csvText) {
    const lines = csvText.split(/\r\n|\n/);
    if(lines.length < 2) return;
    
    const headers = lines[0].split(',');
    const idxMap = {};
    headers.forEach((h, i) => idxMap[h.trim()] = i);
    
    const setMap = {'TWL': 'TWI', 'SOR': 'SOR', 'SHD': 'SHD', 'JTL': 'JTL', 'LOF': 'LOF', 'SEC': 'SEC'};
    const mainAspects = ["Aggression", "Command", "Cunning", "Vigilance"];
    const db = {};

    for(let i=1; i<lines.length; i++) {
        const row = parseCSVLine(lines[i]); 
        if(!row || row.length < headers.length) continue;

        const rawSet = row[idxMap['Source_Sheet']];
        if(!setMap[rawSet]) continue;
        const setCode = setMap[rawSet];

        const id = row[idxMap['Card ID']].split('.')[0].padStart(3, '0');
        const name = row[idxMap['Card Name']];
        const typeRaw = row[idxMap['Type(s)']] || "Unit";
        const costVal = parseInt(row[idxMap['Cost']]) || 0;
        
        const a1 = row[idxMap['Aspect(s)']] || "";
        const a2 = row[idxMap['Unnamed: 12']] || ""; 
        let aspect = "Villainy";
        if(mainAspects.includes(a1)) aspect = a1;
        else if(mainAspects.includes(a2)) aspect = a2;
        else if(a1 === "Villainy" || a1 === "Heroism") aspect = a1;
        else if(a2 === "Villainy" || a2 === "Heroism") aspect = a2;

        const img = `https://swudb.com/images/cards/${setCode}/${id}.png`;
        const cardObj = { id, set: setCode, name, cost: costVal.toString(), aspect, img };

        if(!db[setCode]) db[setCode] = {leaders:[], bases:[], deck:[]};

        if(typeRaw.includes('Leader')) {
            cardObj.type = 'Leader';
            cardObj.back = `https://swudb.com/images/cards/${setCode}/${id}-back.png`;
            db[setCode].leaders.push(cardObj);
        } else if(typeRaw.includes('Base')) {
            cardObj.type = 'Base';
            db[setCode].bases.push(cardObj);
        } else if(typeRaw.includes('Unit') || typeRaw.includes('Event') || typeRaw.includes('Upgrade')) {
            cardObj.type = 'Unit'; 
            db[setCode].deck.push(cardObj);
        }
    }

    LOCAL_DATABASE = db;
    try { localStorage.setItem('SWU_DB', JSON.stringify(db)); } catch(e){}
    document.getElementById('loading-overlay').style.display = 'none';
    initBoard();
}

function parseCSVLine(text) {
    const re_value = /(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
    const a = [];
    text.replace(re_value, function(m0, m1, m2, m3) {
        if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
        else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
        else if (m3 !== undefined) a.push(m3);
        return '';
    });
    if (/,\s*$/.test(text)) a.push('');
    return a;
}

// --- DRAFTER LOGIC ---
function getCostColumn(costVal) {
    const c = parseInt(costVal);
    if (isNaN(c)) return "1"; 
    if (c <= 1) return "1";   
    if (c >= 8) return "8";   
    return c.toString();      
}

function getSetData(setCode) {
    if (LOCAL_DATABASE[setCode] && LOCAL_DATABASE[setCode].deck && LOCAL_DATABASE[setCode].deck.length > 0) {
        return LOCAL_DATABASE[setCode];
    }
    return {leaders:[], bases:[], deck:[]};
}

function openPacks() {
    const btn = document.getElementById('btn-open');
    const setCode = document.getElementById('setSelect').value;
    const packCount = parseInt(document.getElementById('packCount').value) || 6;
    btn.disabled = true;
    playAudio('snd-cantina');

    const setData = getSetData(setCode);
    if(!setData.deck.length) { btn.disabled=false; alert("Vent venligst på at databasen indlæses."); return; }

    currentView = [];
    for(let i=0; i<packCount; i++) {
        if(setData.leaders.length) currentView.push({...setData.leaders[Math.floor(Math.random()*setData.leaders.length)], uid:Date.now()+i+'l', column:'Leader'});
        if(setData.bases.length) currentView.push({...setData.bases[Math.floor(Math.random()*setData.bases.length)], uid:Date.now()+i+'b', column:'Base'});
        for(let k=0; k<14; k++) {
            if(setData.deck.length) {
                const c = setData.deck[Math.floor(Math.random()*setData.deck.length)];
                let col = (currentSortMode === 'cost') ? getCostColumn(c.cost) : c.aspect;
                currentView.push({...c, uid:Date.now()+i+k+'d', column:col});
            }
        }
    }
    renderBoard();
    btn.disabled = false;
}

function initBoard() {
    const board = document.getElementById('board'); board.innerHTML = '';
    let activeCols = (currentSortMode === 'cost') ? ["Leader", "Base", "Pool", ...COST_COLS] : ["Leader", "Base", "Pool", ...ASPECT_COLS];
    
    activeCols.forEach(colName => {
        const col = document.createElement('div'); col.id = `col-${colName}`;
        let cssClass = 'column';
        if (colName === "Leader" || colName === "Base") cssClass += ' col-special';
        if (colName === "Pool") cssClass += ' col-pool'; 
        col.className = cssClass;
        
        // Drag over handlers
        col.ondragover = (e) => { e.preventDefault(); col.classList.add('drag-over'); };
        col.ondragleave = (e) => { col.classList.remove('drag-over'); };
        
        // RETTET: Drop handler til at håndtere kort fra Deck til Board (tilbage)
        col.ondrop = (e) => handleDropOnBoard(e, colName);

        let headerClass = "ch-cost";
        if (colName === "Leader") headerClass = "ch-Leader";
        else if (colName === "Base") headerClass = "ch-Base";
        else if (ASPECT_COLS.includes(colName)) headerClass = `ch-${colName}`;

        col.innerHTML = `<div class="col-header ${headerClass}">${colName}</div><div class="col-content" id="list-${colName}"></div>`;
        board.appendChild(col);
    });
    
    const sidebar = document.getElementById('sidebar');
    sidebar.ondragover = (e) => { e.preventDefault(); sidebar.classList.add('drag-over-deck'); };
    sidebar.ondragleave = (e) => { sidebar.classList.remove('drag-over-deck'); };
    sidebar.ondrop = (e) => handleDropOnDeck(e);
    toggleLeadersBases(true);
}

function renderBoard() {
    const allCols = ["Leader", "Base", "Pool", ...COST_COLS, ...ASPECT_COLS];
    allCols.forEach(c => { const el = document.getElementById(`list-${c}`); if(el) el.innerHTML = ''; });

    const map = {};
    currentView.forEach(c => {
        let target = c.column;
        if (c.type !== 'Leader' && c.type !== 'Base') {
             if (currentSortMode === 'cost') target = getCostColumn(c.cost);
             else target = c.aspect;
        }
        c.column = target;
        const key = `${c.id}_${c.column}`;
        if(map[key]) map[key].count++; else map[key] = {...c, count:1};
    });

    document.getElementById('s-total').innerText = currentView.length;
    Object.values(map).forEach(c => {
        const target = document.getElementById(`list-${c.column}`) || document.getElementById('list-Pool');
        if(!target) return;
        const cardEl = document.createElement('div'); cardEl.className = `card-item`; cardEl.draggable = true;
        // Drag start: Inkluderer info om at den kommer fra Board
        cardEl.ondragstart = (e) => { 
            const payload = JSON.stringify({id: c.id, set: c.set, source: 'board'}); 
            e.dataTransfer.setData("text/plain", payload); 
        };
        cardEl.onclick = (e) => { if(e.target.tagName !== 'DIV') openModal(c); };
        cardEl.onmouseenter = (e) => showPreview(e, c.img, c.type); 
        cardEl.onmouseleave = hidePreview; cardEl.onmousemove = (e) => movePreview(e);
        const stackHtml = c.count > 1 ? `<div class="stack-badge">${c.count}</div>` : '';
        cardEl.innerHTML = `${stackHtml}<img src="${c.img}" draggable="false"><div class="card-actions" onclick="addToDeck('${c.id}', '${c.set}')"><div class="add-icon">+</div></div>`;
        target.appendChild(cardEl);
    });
}

function toggleSort() {
    const btn = document.getElementById('btn-sort');
    currentSortMode = (currentSortMode === 'cost') ? 'aspect' : 'cost';
    btn.innerText = `Sorter: ${currentSortMode === 'cost' ? 'Cost' : 'Aspect'}`;
    initBoard(); renderBoard();
}
function toggleLeadersBases(maintain) {
    if(!maintain) areSpecialColsVisible = !areSpecialColsVisible;
    document.getElementById('col-Leader').style.display = areSpecialColsVisible ? 'flex' : 'none';
    document.getElementById('col-Base').style.display = areSpecialColsVisible ? 'flex' : 'none';
    document.getElementById('btn-toggle-lb').innerText = areSpecialColsVisible ? "Skjul L/B" : "Vis L/B";
}

function addToDeck(id, setCode) {
    const idx = currentView.findIndex(c => c.id === id && c.set === setCode);
    if (idx === -1) return;
    const card = currentView[idx]; currentView.splice(idx, 1); 
    const key = `${card.set}_${card.id}`;
    if(myDeck[key]) myDeck[key].count++; else myDeck[key] = { ...card, count: 1 }; 
    renderBoard(); updateSidebar();
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;
    const card = myDeck[key]; card.count--;
    if(card.count <= 0) delete myDeck[key];
    // Læg tilbage i poolen
    currentView.push({ ...card, count: undefined, uid: Date.now(), column: 'Pool' });
    renderBoard(); updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    Object.values(myDeck).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
        sum += c.count;
        const li = document.createElement('li');
        li.draggable = true;
        // Drag from Sidebar
        li.ondragstart = (e) => { 
             const payload = JSON.stringify({id: c.id, set: c.set, source: 'deck'}); 
             e.dataTransfer.setData("text/plain", payload); 
        };
        
        if(c.type === 'Leader') li.style.borderLeftColor = 'var(--c-leader)';
        else if(c.type === 'Base') li.style.borderLeftColor = 'var(--c-base)';
        else {
            if(c.aspect && c.aspect !== 'Villainy' && c.aspect !== 'Heroism') li.style.borderLeftColor = `var(--c-${c.aspect})`;
            else li.style.borderLeftColor = 'var(--c-unit)';
        }
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent); font-weight:bold;">${c.count}</span>`;
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        li.onmouseenter = (e) => showPreview(e, c.img, c.type);
        li.onmouseleave = hidePreview; li.onmousemove = (e) => movePreview(e);
        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
}

function clearDeck() { Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) currentView.push({...c, count:undefined}); }); myDeck={}; renderBoard(); updateSidebar(); }

function playAudio(id) { const s=document.getElementById(id); if(s){s.volume=0.4; s.currentTime=0; s.play().catch(e=>{});} }

// --- DROP HANDLERS (Drag and Drop Logic) ---
function handleDropOnDeck(e) { 
    e.preventDefault(); 
    try {
        const d=JSON.parse(e.dataTransfer.getData("text/plain")); 
        if(d.source === 'board' && d.id) addToDeck(d.id, d.set);
    } catch(e){} 
    document.getElementById('sidebar').classList.remove('drag-over-deck'); 
}

function handleDropOnBoard(e, colName) {
    e.preventDefault();
    document.getElementById('col-'+colName).classList.remove('drag-over');
    try {
        const d = JSON.parse(e.dataTransfer.getData("text/plain"));
        
        // Hvis kortet kommer fra Decket
        if (d.source === 'deck') {
            const key = `${d.set}_${d.id}`;
            if(myDeck[key]) {
                myDeck[key].count--;
                if(myDeck[key].count <= 0) delete myDeck[key];
                // Hent kort-info fra DB (da deck ikke har fuld info i drag)
                const setData = LOCAL_DATABASE[d.set];
                let cardInfo = setData.deck.find(x=>x.id==d.id) || setData.leaders.find(x=>x.id==d.id) || setData.bases.find(x=>x.id==d.id);
                
                if(cardInfo) {
                    currentView.push({ ...cardInfo, uid: Date.now(), column: colName });
                }
                renderBoard(); updateSidebar();
            }
        }
        // Hvis kortet kommer fra en anden kolonne på boardet (bare for sjov, flytter visuelt)
        else if(d.source === 'board') {
            // Find kortet i currentView og opdater dets column
             const idx = currentView.findIndex(c => c.id === d.id && c.set === d.set);
             if(idx !== -1) {
                 currentView[idx].column = colName;
                 renderBoard();
             }
        }
    } catch(e){}
}


// --- PERFORMANCE OPTIMIZED PREVIEW ---
const tooltip = document.getElementById('preview-tooltip');
let isPreviewing = false;
let ticking = false;

function showPreview(e, src, type) {
    isPreviewing = true;
    tooltip.innerHTML = `<img src="${src}">`;
    tooltip.className = (type==='Leader'||type==='Base') ? 'big-preview' : '';
    tooltip.style.display = 'block'; 
    requestUpdate(e);
}

function movePreview(e) {
    if(!isPreviewing) return;
    requestUpdate(e);
}

function requestUpdate(e) {
    if(!ticking) {
        requestAnimationFrame(() => {
            updatePosition(e);
            ticking = false;
        });
        ticking = true;
    }
}

function updatePosition(e) {
    const w=window.innerWidth; 
    let x=e.clientX+20, y=e.clientY+10;
    const isBig = tooltip.className.includes('big-preview');
    const tipW = isBig ? 600 : 320; // Approx bredde
    
    if(x + tipW > w) x = e.clientX - tipW - 20;
    
    const winH = window.innerHeight; 
    const h = tooltip.offsetHeight || 400;
    if(y+h > winH) y = winH - h - 20;
    
    tooltip.style.top=y+'px'; 
    tooltip.style.left=x+'px';
}

function hidePreview(){
    isPreviewing = false;
    tooltip.style.display='none';
}

const modal = document.getElementById('modal');
const modalImg = document.getElementById('modal-img');
const modalFlipBtn = document.getElementById('modal-flip-btn');
let currentZoomCard = null;
function openModal(c) {
    currentZoomCard=c; modal.style.display='flex';
    if(c.type==='Leader') { modalImg.src=c.img; modalFlipBtn.style.display='block'; }
    else { modalImg.src=c.img; modalFlipBtn.style.display='none'; }
}
function flipLeader(e) {
    if(e) e.stopPropagation();
    if(!currentZoomCard || currentZoomCard.type !== 'Leader') return;
    const isBack = modalImg.src.includes("face=true") || modalImg.src.includes("-back"); 
    modalImg.src = isBack ? currentZoomCard.img : currentZoomCard.back;
}
function closeModal() { modal.style.display='none'; }
function copyJSON() { 
    const d={metadata:{name:"Sealed",author:"SWU"},leader:null,base:null,deck:[],sideboard:[]};
    Object.values(myDeck).forEach(c=>{ const e={id:`${c.set}_${c.id}`,count:c.count}; if(c.type==='Leader') d.leader=e; else if(c.type==='Base') d.base=e; else d.deck.push(e); });
    const el=document.createElement('textarea'); el.value=JSON.stringify(d,null,2); document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); playAudio('snd-copy'); 
    document.getElementById('toast').className = 'show'; setTimeout(()=>document.getElementById('toast').className='', 2000);
}
</script>
</body>
</html>
