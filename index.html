<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: HoloDrafter Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: rgba(20, 20, 20, 0.85);
            --border-glow: rgba(255, 255, 255, 0.1);
            
            --accent: #FFE81F; 
            --accent-glow: rgba(255, 232, 31, 0.6);
            --text-main: #e0e0e0;
            --text-dim: #888;
            
            --c-Aggression: #bd1e2d; --c-Command: #377d22; --c-Cunning: #f2c035;    
            --c-Vigilance: #006eb6; --c-Villainy: #222222; --c-Heroism: #eeeeee; 
            
            --glass: blur(10px);
        }

        body { 
            background: var(--bg-deep) url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat; 
            color: var(--text-main); 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; padding: 0; 
            height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        body::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(5, 5, 5, 0.85); z-index: -1;
        }

        /* --- HEADER --- */
        header { 
            padding: 0 25px; 
            height: 70px;
            background: rgba(10, 10, 10, 0.9);
            border-bottom: 1px solid var(--border-glow);
            backdrop-filter: var(--glass);
            display: flex; align-items: center; justify-content: space-between; 
            z-index: 5000; box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        
        h1 { 
            font-family: 'Orbitron'; color: var(--accent); font-size: 20px; 
            letter-spacing: 2px; text-shadow: 0 0 15px var(--accent-glow); margin: 0; 
            display: flex; align-items: center; gap: 10px;
        }
        
        .controls { display: flex; gap: 15px; align-items: center; }
        
        select, input { 
            background: #151515; color: #fff; border: 1px solid #444; 
            padding: 8px 12px; font-family: 'Orbitron'; font-size: 13px; 
            border-radius: 4px; outline: none; transition: 0.3s; text-transform: uppercase;
        }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        input[type="number"] { width: 50px; text-align: center; }
        
        button.btn { 
            background: rgba(255, 255, 255, 0.05); color: #ccc; 
            border: 1px solid rgba(255,255,255,0.2);
            padding: 9px 18px; font-family: 'Orbitron'; cursor: pointer; transition: all 0.2s; 
            border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        button.btn:hover { 
            background: var(--accent); color: #000; 
            border-color: var(--accent); 
            box-shadow: 0 0 15px var(--accent-glow); 
            transform: translateY(-1px);
        }
        button.btn-action { border-color: var(--accent); color: var(--accent); }
        button.btn-action:hover { background: var(--accent); color: #000; }
        
        button.btn-reset { border-color: #d44; color: #d44; }
        button.btn-reset:hover { background: #d44; color: #fff; border-color: #f66; box-shadow: 0 0 15px rgba(220, 68, 68, 0.6); }

        /* MODE SWITCHER */
        .mode-switch { display: flex; background: #000; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .mode-btn { padding: 9px 16px; cursor: pointer; font-family: 'Orbitron'; font-size: 11px; color: #666; transition: 0.2s; }
        .mode-btn:hover { color: #fff; }
        .mode-btn.active { background: #222; color: var(--accent); font-weight: bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }

        #db-status { font-size: 10px; color: #555; font-family: 'Orbitron'; margin-left: 10px; }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }
        #board { 
            flex: 1; display: flex; gap: 10px; padding: 20px; overflow-x: auto; 
            align-items: flex-start; scroll-behavior: smooth;
        }

        /* --- DRAFT ZONE OVERLAY --- */
        #draft-zone {
            display: none; 
            position: fixed; top: 70px; left: 0; width: 100%; height: calc(100% - 70px);
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 2000;
            flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }
        #draft-info { 
            font-family: 'Orbitron'; color: #fff; font-size: 32px; margin-bottom: 40px; 
            text-shadow: 0 0 20px var(--accent); letter-spacing: 4px;
        }
        #draft-hand {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; 
            width: 100%; max-width: 1300px; padding-bottom: 50px;
        }
        .draft-card {
            width: 180px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; border-radius: 9px; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
        }
        .draft-card:hover { 
            transform: scale(1.1) translateY(-15px); 
            box-shadow: 0 0 35px var(--accent-glow); outline: 2px solid var(--accent);
        }
        .draft-card img { width: 100%; border-radius: 9px; display: block; }

        /* --- COLUMNS --- */
        .column { 
            background: rgba(15, 15, 15, 0.7); 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 8px; 
            display: flex; flex-direction: column; transition: all 0.3s ease; flex-shrink: 0; 
            height: 100%; min-width: 170px; width: 170px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden;
            backdrop-filter: blur(5px);
        }
        .column.drag-over { background: rgba(50, 50, 50, 0.8); border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .col-header { 
            padding: 10px; display: flex; justify-content: space-between; align-items: center;
            font-family: 'Orbitron'; font-weight: 800; font-size: 16px; 
            border-bottom: 2px solid transparent; background: rgba(0,0,0,0.6);
            letter-spacing: 1px;
        }
        .col-toggle {
            background: transparent; border: none; color: #555; cursor: pointer; font-size: 16px; 
        }
        .col-toggle:hover { color: #fff; }

        .ch-Leader { border-color: #fff; color: #fff; }
        .ch-Base { border-color: #aaa; color: #aaa; }
        .ch-Pool { border-color: #fa5; color: #fa5; }
        .ch-cost { border-color: #444; color: #eee; font-size: 20px; }
        
        .col-content { 
            flex: 1; overflow-y: auto; padding: 15px 10px 100px 10px; 
            display: flex; flex-direction: column; align-items: center; 
            scrollbar-width: thin; scrollbar-color: #333 #111;
        }

        /* --- CARD ITEMS --- */
        .card-item { 
            position: relative; background: #000; border-radius: 9px; cursor: grab; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            transition: transform 0.1s, margin 0.3s; width: 100%; z-index: 1; border: 1px solid #222;
        }
        /* Stack effect */
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) { margin-top: -170px; }
        .col-content:hover .card-item:not(:first-child) { margin-top: -120px; }
        
        .card-item:hover { transform: scale(1.05); z-index: 100 !important; border-color: var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .card-item img { width: 100%; border-radius: 9px; display: block; pointer-events: none; }
        
        .shiny::after {
            content: ''; position: absolute; top: 0; left: 0; right:0; bottom:0;
            background: linear-gradient(125deg, transparent 40%, rgba(255,255,255,0.15) 45%, transparent 50%);
            pointer-events: none;
        }
        
        .card-actions { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.6); 
            display: none; align-items: center; justify-content: center; 
            border-radius: 9px; backdrop-filter: blur(2px); 
        }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 30px; color: var(--accent); cursor: pointer; }

        /* --- SIDEBAR --- */
        #sidebar { 
            width: 340px; background: rgba(12, 12, 12, 0.95); 
            border-left: 1px solid #333; display: flex; flex-direction: column; 
            z-index: 4000; flex-shrink: 0; backdrop-filter: blur(10px);
        }
        .sb-header { 
            padding: 15px; background: rgba(20,20,20,0.9); border-bottom: 1px solid #333; 
            font-family: 'Orbitron'; font-size: 14px; text-align: center; color: var(--accent); letter-spacing: 2px;
        }
        
        /* MANA CURVE GRAPHIC */
        #stats-panel { padding: 15px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #333; }
        #mana-curve { 
            display: flex; align-items: flex-end; height: 90px; gap: 8px; margin-top: 10px; 
            border-bottom: 1px solid #444; padding-bottom: 2px;
        }
        .mc-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; }
        .mc-val { font-size: 10px; color: #fff; margin-bottom: 2px; font-weight: bold; }
        .mc-bar { 
            width: 100%; min-height: 2px; border-radius: 2px 2px 0 0; 
            background: linear-gradient(to top, #444, #888);
            transition: height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.8;
        }
        .mc-bar:hover { opacity: 1; filter: brightness(1.2); }
        .mc-label { font-size: 10px; color: #666; margin-top: 5px; font-family: 'Orbitron'; }
        
        .arena-stats { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; color: #888; font-family: 'Orbitron'; }
        .arena-stats span span { color: #fff; font-weight: bold; margin-left: 5px; }

        #deck-list { 
            flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; 
            scrollbar-width: thin; 
        }
        #deck-list li { 
            background: rgba(30,30,30,0.6); padding: 8px 12px; margin-bottom: 4px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 3px solid #555; font-size: 13px; border-radius: 0 4px 4px 0; 
            cursor: pointer; transition: all 0.2s; 
        }
        #deck-list li:hover { background: #333; transform: translateX(4px); }
        
        .sb-footer { padding: 15px; border-top: 1px solid #333; background: rgba(15,15,15,0.9); }
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-full { width: 100%; margin-bottom: 8px; }

        /* BASE PICKER MODAL */
        #base-picker-modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 8000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #base-picker-content {
            background: #151515; border: 1px solid #444; padding: 20px; border-radius: 8px;
            max-width: 800px; max-height: 80vh; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;
        }
        .picker-card { cursor: pointer; transition: 0.2s; }
        .picker-card:hover { transform: scale(1.05); outline: 2px solid var(--accent); }
        .picker-card img { width: 100%; border-radius: 6px; }

        /* PREVIEW TOOLTIP */
        #preview-tooltip { 
            position: fixed; display: none; z-index: 6000; pointer-events: none; 
            background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 8px; 
            padding: 2px; box-shadow: 0 10px 40px rgba(0,0,0,1); 
        }
        #preview-tooltip img { width: 320px; display: block; border-radius: 6px; }

    </style>
</head>
<body>

    <header>
        <h1>SWU DRAFTER</h1>
        
        <div class="controls">
            <div class="mode-switch">
                <div id="mode-sealed" class="mode-btn active" onclick="setMode('sealed')">SEALED</div>
                <div id="mode-draft" class="mode-btn" onclick="setMode('draft')">DRAFT</div>
            </div>

            <select id="setSelect">
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
            </select>
            
            <div id="ctrl-sealed" style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="packCount" value="6" min="1" max="24" title="Number of Packs">
                <button class="btn btn-action" onclick="openPacks()">OPEN PACKS</button>
            </div>

            <div id="ctrl-draft" style="display:none;">
                <button class="btn btn-action" onclick="startDraft()">START DRAFT</button>
            </div>
            
            <button class="btn" onclick="toggleSort()" id="btn-sort">SORT: COST</button>
            <button class="btn btn-reset" onclick="resetDatabase()">RESET DB</button>
            <span id="db-status">DB: Loading...</span>
        </div>
    </header>

    <div id="draft-zone">
        <div id="draft-info">ROUND 1</div>
        <div id="draft-hand"></div>
    </div>

    <div id="main-area">
        <div id="board"></div>
        
        <div id="sidebar">
            <div class="sb-header">DECK LIST (<span id="deck-count">0</span>)</div>
            
            <div id="stats-panel">
                <div id="mana-curve"></div>
                <div class="arena-stats">
                    <span>GROUND: <span id="stat-ground" style="color:#dca">0</span></span>
                    <span>SPACE: <span id="stat-space" style="color:#acd">0</span></span>
                </div>
            </div>

            <ul id="deck-list"></ul>
            
            <div class="sb-footer">
                <button class="btn btn-full" style="border-color: #666; color:#aaa; margin-bottom:15px;" onclick="showBasePicker()">+ ADD COMMON BASE</button>
                <div class="btn-group">
                    <button class="btn btn-full" onclick="saveDeck()">SAVE</button>
                    <button class="btn btn-full" onclick="loadDeck()">LOAD</button>
                </div>
                <button class="btn btn-full" onclick="copyJSON()">COPY JSON</button>
                <button class="btn btn-full btn-reset" onclick="clearDeck()">CLEAR DECK</button>
            </div>
        </div>
    </div>

    <div id="base-picker-modal" onclick="this.style.display='none'">
        <h2 style="color:white; font-family:'Orbitron'">SELECT A BASE</h2>
        <div id="base-picker-content" onclick="event.stopPropagation()"></div>
    </div>

    <div id="preview-tooltip"></div>
    <div style="display:none;" id="upload-trigger"><input type="file" id="csvFile" accept=".csv"></div>

<script>
/* --- CONFIG & STATE --- */
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism"];
let LOCAL_DATABASE = {};
let myDeck = {};
let currentView = [];
let appMode = 'sealed';
let currentSortMode = 'cost';
let draftState = { active: false, round: 1, packSize: 14, set: '', hand: [] };

/* --- INITIALIZATION --- */
window.onload = function() {
    fetch('swu_komplet_database.csv')
        .then(r => { if(!r.ok) throw new Error("No file"); return r.text(); })
        .then(d => parseCSV(d))
        .catch(e => {
            // Check LocalStorage
            const s = localStorage.getItem('SWU_DB_V2');
            if(s) { 
                LOCAL_DATABASE = JSON.parse(s); 
                updateDBStatus(true);
            } else {
                document.getElementById('db-status').innerText = "CLICK TO UPLOAD";
                document.getElementById('db-status').style.cursor = "pointer";
                document.getElementById('db-status').onclick = () => document.getElementById('csvFile').click();
            }
        });
    
    document.getElementById('csvFile').onchange = e => {
        const f = e.target.files[0];
        if(f) { const r = new FileReader(); r.onload = evt => parseCSV(evt.target.result); r.readAsText(f); }
    };
    initBoard();
};

function parseCSV(text) {
    const lines = text.split(/\r?\n/);
    if(lines.length < 2) return;
    const h = lines[0].split(/[;,]/).map(s => s.replace(/"/g, '').trim());
    
    // Column Mapping
    const map = {}; h.forEach((c,i) => map[c] = i);
    const idxID = h.findIndex(c => c.includes("Card ID"));
    const idxSet = h.findIndex(c => c.includes("Source") || c === "SET");
    const idxName = map["Card Name"];
    const idxCost = map["Cost"];
    const idxType = h.findIndex(c => c.includes("Type"));
    const idxRarity = map["Rarity"];
    const idxArena = map["Arena"];
    const idxAspect1 = map["Aspect(s)"];
    const idxAspect2 = h.findIndex(c => c.includes("Unnamed"));

    const db = {};
    const setMap = {'TWL':'TWI', 'TWI':'TWI', 'SOR':'SOR', 'SHD':'SHD', 'JTL':'JTL', 'LOF':'LOF', 'SEC':'SEC'};

    for(let i=1; i<lines.length; i++) {
        // Simple regex split for CSV (handles simple quotes)
        let row = [];
        let cur = ''; let inQ = false;
        for(let c of lines[i]) {
            if(c === '"') { inQ = !inQ; }
            else if((c===',' || c===';') && !inQ) { row.push(cur.trim()); cur=''; }
            else { cur += c; }
        }
        row.push(cur.trim());

        if(row.length < 5) continue;

        const rawSet = row[idxSet] ? row[idxSet].replace(/"/g,'') : '';
        const setCode = setMap[rawSet] || rawSet;
        if(!setCode || setCode.length !== 3) continue;

        const id = row[idxID].split('.')[0].padStart(3, '0');
        const name = row[idxName];
        const cost = parseInt(row[idxCost]) || 0;
        const typeRaw = row[idxType] || "Unit";
        const rarityRaw = row[idxRarity] ? row[idxRarity].charAt(0) : 'C';
        
        let simpleType = "Unit";
        if(typeRaw.toLowerCase().includes("leader")) simpleType = "Leader";
        else if(typeRaw.toLowerCase().includes("base")) simpleType = "Base";
        
        // Skip tokens
        if(id === "000" || name === "Token") continue;

        // Determine Rarity
        let rarity = "Common";
        if(rarityRaw === 'U') rarity = "Uncommon";
        if(rarityRaw === 'R') rarity = "Rare";
        if(rarityRaw === 'L') rarity = "Legendary";
        if(rarityRaw === 'S') rarity = "Special";

        // Determine Aspect
        let asp = row[idxAspect1] || "Neutral";
        if(aspectCheck(asp) === "Neutral" && row[idxAspect2] && aspectCheck(row[idxAspect2]) !== "Neutral") {
            asp = row[idxAspect2];
        }
        asp = aspectCheck(asp);

        // Image
        const img = `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${id}.png`;
        const card = { id, set: setCode, name, cost, type: simpleType, rarity, aspect: asp, img, arena: row[idxArena] || "" };

        if(!db[setCode]) db[setCode] = { deck:[], leaders:[], bases:[] };
        
        if(simpleType === 'Leader') db[setCode].leaders.push(card);
        else if(simpleType === 'Base') db[setCode].bases.push(card);
        else db[setCode].deck.push(card);
    }
    
    LOCAL_DATABASE = db;
    localStorage.setItem('SWU_DB_V2', JSON.stringify(db));
    updateDBStatus(true);
}

function aspectCheck(str) {
    if(!str) return "Neutral";
    const s = str.toLowerCase();
    if(s.includes("agg")) return "Aggression";
    if(s.includes("com")) return "Command";
    if(s.includes("cun")) return "Cunning";
    if(s.includes("vig")) return "Vigilance";
    if(s.includes("vil")) return "Villainy";
    if(s.includes("her")) return "Heroism";
    return "Neutral";
}

function updateDBStatus(ok) {
    const el = document.getElementById('db-status');
    let c = 0; Object.values(LOCAL_DATABASE).forEach(s => c += s.deck.length);
    el.innerText = ok ? `DB READY (${c} Cards)` : "DB ERROR";
    el.style.color = ok ? "#0f0" : "#f00";
}

/* --- LOGIC --- */
function setMode(m) {
    appMode = m;
    document.getElementById('mode-sealed').classList.toggle('active', m === 'sealed');
    document.getElementById('mode-draft').classList.toggle('active', m === 'draft');
    document.getElementById('ctrl-sealed').style.display = m === 'sealed' ? 'flex' : 'none';
    document.getElementById('ctrl-draft').style.display = m === 'draft' ? 'flex' : 'none';
    currentView = []; myDeck = {}; renderBoard(); updateSidebar();
}

function getSetData(s) { return LOCAL_DATABASE[s] || {deck:[], leaders:[], bases:[]}; }

function openPacks() {
    const set = document.getElementById('setSelect').value;
    const num = parseInt(document.getElementById('packCount').value) || 6;
    const data = getSetData(set);
    
    if(data.deck.length === 0) { alert("Set data missing!"); return; }

    currentView = [];
    myDeck = {};
    updateSidebar();

    for(let i=0; i<num; i++) {
        // 1 Leader
        if(data.leaders.length) currentView.push({...data.leaders[Math.floor(Math.random()*data.leaders.length)], uid: Math.random(), col: 'Leader'});
        // 1 Base (Guaranteed now for all sets including LOF)
        if(data.bases.length) {
             currentView.push({...data.bases[Math.floor(Math.random()*data.bases.length)], uid: Math.random(), col: 'Base'});
        } else {
             // Fallback if no bases parsed for set (shouldn't happen with correct DB)
             console.warn("No bases found for set " + set);
        }
        
        // 14 Deck cards
        for(let k=0; k<14; k++) {
            const c = data.deck[Math.floor(Math.random()*data.deck.length)];
            let col = getSortColumn(c);
            currentView.push({...c, uid: Math.random(), col: col});
        }
    }
    renderBoard();
}

function startDraft() {
    draftState = { active: true, round: 1, packSize: 14, set: document.getElementById('setSelect').value, hand: [], phase: 'LEADER' };
    const d = getSetData(draftState.set);
    if(!d.deck.length) return;

    currentView = []; myDeck = {}; updateSidebar(); renderBoard();
    
    // Add Common Bases to Pool automatically for Draft
    d.bases.filter(b => b.rarity === 'Common').forEach(b => {
        currentView.push({...b, uid: Math.random(), col: 'Base'});
    });
    
    document.getElementById('draft-zone').style.display = 'flex';
    nextDraftStep();
}

function nextDraftStep() {
    const d = getSetData(draftState.set);
    draftState.hand = [];
    const info = document.getElementById('draft-info');

    if(draftState.phase === 'LEADER') {
        if(draftState.round > 3) {
            draftState.phase = 'PACK1'; draftState.round = 1; draftState.packSize = 14;
            nextDraftStep(); return;
        }
        info.innerText = `DRAFT LEADERS (${4-draftState.round} LEFT)`;
        for(let i=0; i<(4-draftState.round); i++) draftState.hand.push(d.leaders[Math.floor(Math.random()*d.leaders.length)]);
    } else {
        info.innerText = `PACK PICK (${draftState.packSize} LEFT)`;
        for(let i=0; i<draftState.packSize; i++) draftState.hand.push(d.deck[Math.floor(Math.random()*d.deck.length)]);
    }
    renderHand();
}

function renderHand() {
    const h = document.getElementById('draft-hand'); h.innerHTML = '';
    draftState.hand.forEach(c => {
        const el = document.createElement('div'); el.className = 'draft-card';
        el.innerHTML = `<img src="${c.img}">`;
        el.onclick = () => pickCard(c);
        el.onmouseenter = e => showPreview(c.img); el.onmouseleave = hidePreview;
        el.onmousemove = movePreview;
        h.appendChild(el);
    });
}

function pickCard(c) {
    let col = c.type === 'Leader' ? 'Leader' : c.type === 'Base' ? 'Base' : getSortColumn(c);
    currentView.push({...c, uid: Math.random(), col: col});
    renderBoard();
    
    if(draftState.phase === 'LEADER') {
        draftState.round++; nextDraftStep();
    } else {
        draftState.packSize--;
        if(draftState.packSize <= 0) {
            if(draftState.phase === 'PACK1') draftState.phase = 'PACK2';
            else if(draftState.phase === 'PACK2') draftState.phase = 'PACK3';
            else { document.getElementById('draft-zone').style.display='none'; draftState.active=false; return; }
            draftState.packSize = 14;
        }
        nextDraftStep();
    }
}

/* --- BOARD UI --- */
function getSortColumn(c) {
    if(c.type === 'Leader') return 'Leader';
    if(c.type === 'Base') return 'Base';
    if(currentSortMode === 'cost') return (c.cost > 8 ? '8' : c.cost < 1 ? '1' : c.cost.toString());
    return c.aspect; // Aspect sort
}

function toggleSort() {
    currentSortMode = currentSortMode === 'cost' ? 'aspect' : 'cost';
    document.getElementById('btn-sort').innerText = `SORT: ${currentSortMode.toUpperCase()}`;
    currentView.forEach(c => c.col = getSortColumn(c));
    initBoard(); renderBoard();
}

function initBoard() {
    const b = document.getElementById('board'); b.innerHTML = '';
    const cols = currentSortMode === 'cost' 
        ? ['Leader', 'Base', ...COST_COLS] 
        : ['Leader', 'Base', ...ASPECT_COLS];
    
    cols.forEach(id => {
        const d = document.createElement('div'); d.className = 'column';
        d.id = `col-${id}`;
        let label = id; 
        if(id==='8') label='8+';
        
        // Color coding headers
        let colorClass = `ch-${id}`;
        if(!isNaN(parseInt(id))) colorClass = 'ch-cost';

        d.innerHTML = `
            <div class="col-header ${colorClass}">
                <span>${label}</span>
                <button class="col-toggle" onclick="toggleCol('${id}')">-</button>
            </div>
            <div class="col-content" id="list-${id}"></div>
        `;
        // Drag drop handlers
        d.ondragover = e => { e.preventDefault(); d.classList.add('drag-over'); };
        d.ondragleave = () => d.classList.remove('drag-over');
        d.ondrop = e => dropToBoard(e, id);
        b.appendChild(d);
    });
}

function toggleCol(id) {
    const el = document.getElementById(`list-${id}`);
    const col = document.getElementById(`col-${id}`);
    if(el.style.display === 'none') { el.style.display='flex'; col.style.height='100%'; }
    else { el.style.display='none'; col.style.height='auto'; }
}

function renderBoard() {
    // Clear lists
    document.querySelectorAll('.col-content').forEach(e => e.innerHTML='');
    
    // Group duplicates logic could go here, but for pool we list individually usually.
    // Let's stack duplicates in pool for cleaner UI
    let displayMap = {};
    
    currentView.forEach(c => {
        let key = c.id + '_' + c.col;
        if(!displayMap[key]) displayMap[key] = { ...c, count: 0 };
        displayMap[key].count++;
    });

    Object.values(displayMap).forEach(c => {
        const list = document.getElementById(`list-${c.col}`);
        if(!list) return;
        
        const el = document.createElement('div');
        el.className = 'card-item' + (c.rarity==='Legendary'||c.rarity==='Rare'?' shiny':'');
        el.innerHTML = `<img src="${c.img}">
                        <div class="card-actions">
                            <div class="add-icon" onclick="moveToDeck('${c.id}')">+</div>
                        </div>`;
        if(c.count > 1) {
            // Add a badge
            const badge = document.createElement('div');
            badge.style.cssText = "position:absolute;top:-5px;right:-5px;background:#fa0;color:#000;border-radius:50%;width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-weight:bold;z-index:200;box-shadow:0 2px 5px #000;";
            badge.innerText = c.count;
            el.appendChild(badge);
        }

        // Drag events
        el.draggable = true;
        el.ondragstart = e => e.dataTransfer.setData('text/plain', JSON.stringify({id: c.id, from: 'board'}));
        el.onmouseenter = e => showPreview(c.img); 
        el.onmouseleave = hidePreview;
        el.onmousemove = movePreview;

        list.appendChild(el);
    });
}

/* --- DECK MANAGEMENT --- */
function moveToDeck(id) {
    // Find one instance in view
    const idx = currentView.findIndex(x => x.id === id);
    if(idx === -1) return;
    const card = currentView[idx];
    currentView.splice(idx, 1);
    
    if(!myDeck[id]) myDeck[id] = { ...card, count: 0 };
    myDeck[id].count++;
    
    renderBoard();
    updateSidebar();
}

function removeFromDeck(id) {
    if(!myDeck[id]) return;
    myDeck[id].count--;
    const card = myDeck[id];
    
    // Return to board
    let col = getSortColumn(card);
    currentView.push({ ...card, uid: Math.random(), col: col });
    
    if(myDeck[id].count <= 0) delete myDeck[id];
    
    renderBoard();
    updateSidebar();
}

function updateSidebar() {
    const list = document.getElementById('deck-list'); list.innerHTML = '';
    let total = 0;
    let ground = 0, space = 0;
    let curve = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};
    let max = 0;

    Object.values(myDeck).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
        total += c.count;
        if(c.arena === 'Ground') ground += c.count;
        if(c.arena === 'Space') space += c.count;
        
        // Curve Logic
        if(c.type === 'Unit' || c.type === 'Event' || c.type === 'Upgrade') {
            let cost = c.cost > 8 ? 8 : (c.cost < 1 ? 1 : c.cost);
            curve[cost] += c.count;
            if(curve[cost] > max) max = curve[cost];
        }

        const li = document.createElement('li');
        li.innerHTML = `<span>${c.name}</span> <span style="color:#fff; font-weight:bold;">x${c.count}</span>`;
        li.style.borderLeftColor = `var(--c-${c.aspect})`;
        li.onclick = () => removeFromDeck(c.id);
        
        // Drag from deck
        li.draggable = true;
        li.ondragstart = e => e.dataTransfer.setData('text/plain', JSON.stringify({id: c.id, from: 'deck'}));
        li.onmouseenter = e => showPreview(c.img);
        li.onmouseleave = hidePreview;
        li.onmousemove = movePreview;

        list.appendChild(li);
    });

    document.getElementById('deck-count').innerText = total;
    document.getElementById('stat-ground').innerText = ground;
    document.getElementById('stat-space').innerText = space;

    // Render Mana Curve
    const mc = document.getElementById('mana-curve'); mc.innerHTML = '';
    for(let i=1; i<=8; i++) {
        const val = curve[i];
        const h = max > 0 ? (val / max * 100) : 0;
        const col = document.createElement('div'); col.className = 'mc-col';
        
        // Dynamic Color based on height/intensity
        let barColor = `linear-gradient(to top, #444, #666)`;
        if(h > 60) barColor = `linear-gradient(to top, var(--accent-glow), var(--accent))`;
        else if(h > 20) barColor = `linear-gradient(to top, #006eb6, #55aaff)`;

        col.innerHTML = `
            <div class="mc-val">${val || ''}</div>
            <div class="mc-bar" style="height:${h}%; background:${barColor}"></div>
            <div class="mc-label">${i}${i===8?'+':''}</div>
        `;
        mc.appendChild(col);
    }
}

/* --- ADD COMMON BASE FEATURE --- */
function showBasePicker() {
    const set = document.getElementById('setSelect').value;
    const d = getSetData(set);
    const modal = document.getElementById('base-picker-modal');
    const content = document.getElementById('base-picker-content');
    content.innerHTML = '';

    // Filter common bases from current set
    const commons = d.bases.filter(b => b.rarity === 'Common');
    
    if(commons.length === 0) {
        alert("No common bases found in " + set);
        return;
    }

    commons.forEach(b => {
        const el = document.createElement('div');
        el.className = 'picker-card';
        el.innerHTML = `<img src="${b.img}">`;
        el.onclick = () => {
            if(!myDeck[b.id]) myDeck[b.id] = {...b, count:1};
            else alert("You already have this base.");
            updateSidebar();
            modal.style.display = 'none';
        };
        content.appendChild(el);
    });
    
    modal.style.display = 'flex';
}

/* --- UTILS --- */
function resetDatabase() { localStorage.removeItem('SWU_DB_V2'); location.reload(); }
function clearDeck() { 
    // Move all back to board if not drafting
    if(!draftState.active) {
        Object.values(myDeck).forEach(c => {
            for(let i=0; i<c.count; i++) currentView.push({...c, uid:Math.random(), col:getSortColumn(c)});
        });
        renderBoard();
    }
    myDeck = {}; updateSidebar(); 
}

function saveDeck() {
    if(Object.keys(myDeck).length === 0) return;
    localStorage.setItem('SWU_SAVED', JSON.stringify(myDeck));
    alert("Deck Saved!");
}
function loadDeck() {
    const s = localStorage.getItem('SWU_SAVED');
    if(s) { myDeck = JSON.parse(s); updateSidebar(); }
}
function copyJSON() {
    const ids = [];
    Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) ids.push(c.id); });
    navigator.clipboard.writeText(JSON.stringify(myDeck, null, 2));
    alert("JSON Copied to Clipboard");
}

/* --- DRAG DROP --- */
function dropToBoard(e, colId) {
    const d = JSON.parse(e.dataTransfer.getData('text/plain'));
    if(d.from === 'deck') {
        removeFromDeck(d.id); // This puts it back in view, we need to find it and move it to specific col
        // This is a bit tricky with current logic because remove puts it in default col.
        // We will just let it reset to default col for simplicity in this version.
    } else {
        // Reordering within board not implemented deeply, just visual shift
        const item = currentView.find(x => x.id === d.id);
        if(item) { item.col = colId; renderBoard(); }
    }
}

/* --- PREVIEW --- */
const tip = document.getElementById('preview-tooltip');
function showPreview(src) { 
    tip.innerHTML = `<img src="${src}">`; 
    tip.style.display = 'block'; 
}
function hidePreview() { tip.style.display = 'none'; }
function movePreview(e) {
    const x = e.clientX, y = e.clientY;
    const w = window.innerWidth, h = window.innerHeight;
    
    let left = x + 20;
    let top = y - 100;

    if(left + 320 > w) left = x - 340;
    if(top + 450 > h) top = h - 460;
    if(top < 0) top = 10;

    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
}
</script>
</body>
</html>
