import csv
import json
import os

# --- 1. INDLÆS OG BEHANDLE CSV-DATA ---
print("Indlæser database...")

db = {}
# Mapping af sæt-koder (CSV -> App)
set_map = {
    'TWL': 'TWI', # Mapper CSV'ens TWL til appens TWI
    'SOR': 'SOR',
    'SHD': 'SHD',
    'JTL': 'JTL',
    'LOF': 'LOF',
    'SEC': 'SEC'
}

csv_filename = "swu_komplet_database.csv"

try:
    with open(csv_filename, "r", encoding="utf-8") as f:
        # Håndterer 'Unnamed: 12' som den anden aspect-kolonne
        reader = csv.DictReader(f)
        
        for row in reader:
            raw_set = row.get('Source_Sheet', '').strip()
            if raw_set not in set_map:
                continue
                
            set_code = set_map[raw_set]
            
            # ID og Navn
            card_id = str(row.get('Card ID', '')).zfill(3)
            name = row.get('Card Name', 'Unknown')
            
            # Type (Leader, Base, Unit)
            raw_type = row.get('Type(s)', '').lower()
            if 'token' in raw_type: continue # Spring tokens over
            
            if 'leader' in raw_type: card_type = "Leader"
            elif 'base' in raw_type: card_type = "Base"
            else: card_type = "Unit"
            
            # Cost (Håndter NaN/Tomme felter)
            try:
                cost = int(float(row.get('Cost', 0)))
            except ValueError:
                cost = 0
                
            # Aspects (Kombiner Aspect(s) og Unnamed: 12)
            aspects_list = []
            if row.get('Aspect(s)'): aspects_list.append(row['Aspect(s)'])
            if row.get('Unnamed: 12'): aspects_list.append(row['Unnamed: 12'])
            aspect_str = " ".join(aspects_list)
            
            # Rarity
            rarity = row.get('Rarity', 'C')
            
            # Opbyg struktur
            if set_code not in db:
                db[set_code] = {}
            
            # Gem kortdata (minimeret nøgler for at spare plads)
            db[set_code][card_id] = {
                "n": name,
                "c": cost,
                "a": aspect_str,
                "t": card_type,
                "r": rarity
            }
            
    print(f"Database behandlet. Antal sæt: {len(db)}")

except FileNotFoundError:
    print(f"FEJL: Kunne ikke finde '{csv_filename}'. Sørg for at filen ligger i samme mappe.")
    exit()

# --- 2. DEFINER HTML TEMPLATE MED OPDATERET JS (Inkl. portrait fix) ---

html_template_start = """<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: Ultimate Drafter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #FFE81F;
            --text-main: #e0e0e0;
            
            /* Type Colors */
            --c-leader: #eee;
            --c-base: #888;
            --c-unit: #444; 
            --c-pool: #553333; 
            
            --success-green: #0a0;
        }

        body {
            background: var(--bg); color: var(--text-main); font-family: 'Rajdhani', sans-serif;
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 20px; background: #000; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            height: 50px; z-index: 10;
        }

        h1 { margin: 0; font-family: 'Orbitron'; color: var(--accent); font-size: 18px; letter-spacing: 1px; }

        .controls { display: flex; gap: 10px; align-items: center; }
        
        select, input { background: #111; color: var(--accent); border: 1px solid #444; padding: 5px 10px; font-family: 'Orbitron'; font-size: 14px; border-radius: 4px; }
        input { width: 50px; text-align: center; }
        
        button.btn {
            background: #333; color: white; border: 1px solid #555;
            padding: 5px 15px; font-family: 'Orbitron'; cursor: pointer; transition: 0.2s; border-radius: 4px;
            font-size: 12px; text-transform: uppercase;
        }
        button.btn:hover { border-color: var(--accent); color: var(--accent); background: #000; }

        button.btn-pew {
            background: #822; border-color: #a44; color: #fff; font-weight: bold;
        }
        button.btn-pew:hover { background: #b33; border-color: #f66; color: #fff; transform: scale(1.1); }
        
        .stat { font-family: 'Orbitron'; font-size: 14px; color: #aaa; margin-right: 20px; }
        .stat span { color: var(--accent); }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; }

        /* --- BOARD --- */
        #board {
            flex: 1; display: flex; gap: 10px; padding: 15px;
            overflow-x: auto; 
            background: url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat;
            align-items: flex-start;
        }
        #board::before {
            content:''; position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.85); z-index: -1; pointer-events: none;
        }

        /* --- COLUMNS --- */
        .column {
            background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; transition: all 0.2s;
            flex-shrink: 0; 
            height: 100%; 
            min-width: 150px; 
            width: 150px;
        }
        .column.drag-over { background: rgba(60, 60, 60, 0.95); box-shadow: 0 0 25px var(--accent); border-color: var(--accent); }

        /* Special Columns */
        .col-special { width: 170px; min-width: 170px; border: 1px solid #555; }
        
        /* POOL COLUMN - Bredere til 3 kort */
        .col-pool { width: 450px; min-width: 450px; border: 1px solid #644; background: rgba(30, 20, 20, 0.9); }

        .col-header {
            padding: 8px; text-align: center; font-family: 'Orbitron'; font-weight: bold; font-size: 16px;
            border-bottom: 2px solid transparent; text-transform: uppercase;
            background: rgba(0,0,0,0.6); border-top-left-radius: 8px; border-top-right-radius: 8px; z-index: 5;
        }
        
        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); }
        .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); }
        .ch-Pool { border-bottom-color: var(--c-pool); color: #faa; font-size: 18px; letter-spacing: 2px; background: rgba(80,40,40,0.8); }
        .ch-cost { border-bottom-color: var(--c-unit); color: #fff; font-size: 20px; }

        .col-content { 
            flex: 1; overflow-y: auto; overflow-x: visible; 
            padding: 15px 10px 50px 10px; 
            display: flex; flex-direction: column; 
            align-items: center;
        }

        /* SPECIFIKT FOR POOL INDHOLD (GRID 3 KORT) */
        #list-Pool {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            align-content: start;
            align-items: start;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 280px; background: #111; border-left: 1px solid #333;
            display: flex; flex-direction: column; z-index: 100;
            transition: all 0.2s; position: relative; flex-shrink: 0;
        }
        #sidebar.drag-over-deck {
            background: #1a1a1a;
            box-shadow: inset 0 0 20px var(--success-green);
            border-left: 2px solid var(--success-green);
        }
        #sidebar.drag-over-deck::after {
            content: 'SLIP FOR AT TILFØJE';
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--success-green); font-family: 'Orbitron'; font-weight: bold; width: 100%; text-align: center; pointer-events: none;
        }

        .sb-header { padding: 15px; background: #181818; border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); }
        #deck-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        #deck-list li {
            background: #222; padding: 6px 10px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid #555; font-size: 13px; border-radius: 3px; cursor: pointer; transition: background 0.2s;
        }
        #deck-list li:hover { background: #444; color: #fff; }
        .sb-footer { padding: 10px; border-top: 1px solid #333; background: #181818; }

        /* --- CARD ITEM --- */
        .card-item {
            position: relative; background: #000; border-radius: 6px;
            cursor: grab; box-shadow: 0 -2px 5px rgba(0,0,0,0.5); 
            transition: transform 0.1s ease-out, margin 0.2s; 
            display: flex; flex-direction: column;
            width: 100%;
            z-index: 1; 
        }

        /* STACKING MAGIC (Kabale effekt) - Gælder KUN 1-8 */
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) {
            margin-top: -135px; 
        }

        /* I Pool/Leader/Base skal de ligge pænt uden overlap */
        #list-Pool .card-item, #list-Leader .card-item, #list-Base .card-item {
            margin-top: 5px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.6); 
        }

        /* HOVER EFFECT - STANDARD ZOOM I KOLONNER */
        .card-item:hover { 
            transform: scale(1.35) translateY(-10px); 
            z-index: 1000 !important; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); 
            border: 1px solid var(--accent);
        }
        
        .card-item img { width: 100%; height: auto; display: block; border-radius: 6px; pointer-events: none; }

        .card-actions { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); display: none; 
            align-items: center; justify-content: center; border-radius: 6px;
        }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { 
            font-size: 24px; color: #fff; font-weight: bold; text-shadow: 0 0 10px #000; pointer-events: none; 
            background: rgba(0,0,0,0.6); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; border: 2px solid #fff;
        }

        .stack-badge {
            position: absolute; top: 5px; right: 5px; background: var(--accent); color: #000;
            width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 11px; font-weight: 900; border: 2px solid #000; z-index: 5; box-shadow: 2px 2px 5px #000;
        }

        /* --- PREVIEW TOOLTIP (MOUSE OVER ZOOM) --- */
        #preview-tooltip {
            position: fixed; display: none; z-index: 5000; pointer-events: none;
            background: rgba(0,0,0,0.8); border: 2px solid #555;
            border-radius: 8px; padding: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            overflow: hidden;
        }
        /* Standard størrelse */
        #preview-tooltip img { width: 320px; display: block; border-radius: 6px; }
        
        /* KÆMPE ZOOM til Leaders/Bases (Justeret til 60vh) */
        #preview-tooltip.big-preview img { 
            width: auto; 
            height: 60vh; 
            max-width: none; 
        }

        /* --- MODAL FOR CARD VIEW --- */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
        
        .modal-card-container {
            position: relative;
            margin-bottom: 20px; 
            cursor: pointer; /* Viser hånd */
        }
        
        /* Overlay ikon på kortet ved hover i modal */
        .modal-card-container:hover::after {
            content: '↻';
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 100px; color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 20px #000; pointer-events: none;
        }

        #modal img { 
            max-width:90vw; max-height:70vh; /* Gør plads til knappen i bunden */
            border-radius: 10px; 
            display: block;
            box-shadow: 0 0 50px #000;
            border: 2px solid #333;
        }
        
        /* NY TYDELIG KNAP STYLE */
        .big-flip-btn {
            background: var(--accent);
            color: #000;
            font-family: 'Orbitron';
            font-size: 24px;
            font-weight: 900;
            padding: 15px 40px;
            border: 3px solid #000;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 20px var(--accent);
            animation: pulse 2s infinite;
            display: none; /* Default hidden */
        }
        .big-flip-btn:hover {
            background: #fff;
            transform: scale(1.05);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 232, 31, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 232, 31, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 232, 31, 0); }
        }

        #toast {
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent);
        }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <header>
        <div class="controls">
            <h1>SWU Drafter</h1>
            <select id="setSelect">
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="SEC">Secrets of Power (SEC)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
            </select>
            <label style="color:#aaa; font-size:12px;">Pakker:</label>
            <input type="number" id="packCount" value="6" min="1" max="24">
            <button class="btn" onclick="openPacks()">ÅBN</button>
            <button class="btn" id="btn-toggle-lb" onclick="toggleLeadersBases()">Skjul L/B</button>
            <button class="btn btn-pew" onclick="playAudio('snd-pew')">PEW PEW!</button>
        </div>
        <div id="stats">
            <span class="stat">Pool: <span id="s-total">0</span></span>
        </div>
    </header>

    <div id="main-area">
        <div id="board"></div>

        <div id="sidebar">
            <div class="sb-header">Dit Deck (<span id="deck-count">0</span>)</div>
            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <button class="btn" style="width:100%" onclick="copyJSON()">Kopiér JSON</button>
                <button class="btn" style="width:100%; margin-top:5px; background:#4a1a1a; border-color:#6a2a2a;" onclick="clearDeck()">Slet Deck</button>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-card-container" onclick="flipLeader(event)">
            <img id="modal-img">
        </div>
        <button id="modal-flip-btn" class="big-flip-btn" onclick="flipLeader(event)">VEND LEADER ↻</button>
        <div id="flip-hint" style="color:#fff; margin-top:10px; font-family:'Orbitron'; display:none;">(Tryk Mellemrum for at vende)</div>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">Udført</div>
    
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-pew" src="https://www.myinstants.com/media/sounds/pew-pew-pew-pew-pew.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>

<script>
// --- CONFIG ---
const COLUMNS = ["Leader", "Base", "Pool", "1", "2", "3", "4", "5", "6", "7", "8"];

// --- DATABASE (INDSÆTTES HER AF PYTHON SCRIPT) ---
const CARD_DATABASE = """

html_script_end = """;

// --- APP STATE ---
let myDeck = {};
let currentView = [];
let areSpecialColsVisible = true; 

// --- GENERATOR & MAPPING ---
function generateCard(idStr, setCode) {
    if(!CARD_DATABASE[setCode]) return null;
    const dbData = CARD_DATABASE[setCode][idStr];
    if(!dbData) return null;
    
    // Bestem Type og Kolonne
    const type = dbData.t;
    let initialColumn = "Pool";
    
    if (type === "Leader") {
        initialColumn = "Leader";
    } else if (type === "Base") {
        initialColumn = "Base";
    } else {
        // SORTERING EFTER COST (0-1 -> 1, 2->2 ... 8+ -> 8)
        const c = dbData.c;
        if (c <= 1) initialColumn = "1";
        else if (c === 2) initialColumn = "2";
        else if (c === 3) initialColumn = "3";
        else if (c === 4) initialColumn = "4";
        else if (c === 5) initialColumn = "5";
        else if (c === 6) initialColumn = "6";
        else if (c === 7) initialColumn = "7";
        else initialColumn = "8"; // 8-16
    }

    let card = {
        id: idStr,
        set: setCode,
        name: dbData.n,
        type: type,
        cost: dbData.c,
        aspects: dbData.a || "",
        column: initialColumn, 
        img: `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${idStr}.png`
    };
    
    if(card.type === "Leader") {
        card.imgFront = card.img;
        // RETTET: Bruger nu '-portrait.png' til Leader Unit siden (flip)
        card.imgBack = `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${idStr}-portrait.png`;
    }
    return card;
}

// --- INITIALIZE BOARD ---
function initBoard() {
    const board = document.getElementById('board');
    board.innerHTML = '';
    
    COLUMNS.forEach(colName => {
        const col = document.createElement('div');
        col.id = `col-${colName}`;
        
        let cssClass = 'column';
        if (colName === "Leader" || colName === "Base") cssClass += ' col-special';
        if (colName === "Pool") cssClass += ' col-pool'; 
        
        col.className = cssClass;
        
        col.ondragover = (e) => { e.preventDefault(); col.classList.add('drag-over'); };
        col.ondragleave = (e) => { col.classList.remove('drag-over'); };
        col.ondrop = (e) => handleDropOnBoard(e, colName);

        let headerClass = "ch-cost";
        if (colName === "Leader") headerClass = "ch-Leader";
        if (colName === "Base") headerClass = "ch-Base";
        if (colName === "Pool") headerClass = "ch-Pool";

        col.innerHTML = `
            <div class="col-header ${headerClass}">${colName}</div>
            <div class="col-content" id="list-${colName}"></div>
        `;
        board.appendChild(col);
    });

    const sidebar = document.getElementById('sidebar');
    sidebar.ondragover = (e) => { e.preventDefault(); sidebar.classList.add('drag-over-deck'); };
    sidebar.ondragleave = (e) => { sidebar.classList.remove('drag-over-deck'); };
    sidebar.ondrop = (e) => handleDropOnDeck(e);
    
    document.addEventListener('keydown', function(e) {
        if (e.code === 'Space' && document.getElementById('modal').style.display === 'flex') {
            e.preventDefault(); 
            flipLeader();
        }
    });
}

function toggleLeadersBases() {
    const colLeader = document.getElementById('col-Leader');
    const colBase = document.getElementById('col-Base');
    const btn = document.getElementById('btn-toggle-lb');

    if (areSpecialColsVisible) {
        colLeader.style.display = 'none';
        colBase.style.display = 'none';
        btn.innerText = "Vis L/B";
        areSpecialColsVisible = false;
    } else {
        colLeader.style.display = 'flex'; 
        colBase.style.display = 'flex';
        btn.innerText = "Skjul L/B";
        areSpecialColsVisible = true;
    }
}

function playAudio(elementId) {
    const snd = document.getElementById(elementId);
    if(snd) {
        snd.volume = 0.4;
        snd.currentTime = 0;
        snd.play().catch(e => console.log("Lyd fejl:", e));
    }
}

// --- DRAFT LOGIC ---
function openPacks() {
    playAudio('snd-cantina');

    const setCode = document.getElementById('setSelect').value;
    const packCount = parseInt(document.getElementById('packCount').value) || 6;
    
    const setDB = CARD_DATABASE[setCode];
    if(!setDB) return alert("Ingen data for " + setCode + " i databasen.");

    // Opret Pool: 1x Leaders/Bases, 3x Units (Draft Pool Simulation)
    let pool = [];
    Object.keys(setDB).forEach(idStr => {
        const card = generateCard(idStr, setCode);
        if(!card) return;
        
        let copies = 3;
        if(card.type === 'Leader' || card.type === 'Base') copies = 1;
        
        for(let i=0; i<copies; i++) {
            pool.push({ ...card, uid: `${idStr}-${i}` });
        }
    });

    // Simuler pakkeåbning (Vælg tilfældige kort fra puljen)
    let allLeaders = pool.filter(c => c.type === 'Leader');
    let allBases = pool.filter(c => c.type === 'Base');
    let allUnits = pool.filter(c => c.type !== 'Leader' && c.type !== 'Base');

    currentView = [];
    
    for(let i=0; i<packCount; i++) {
        // 1 Leader
        if(allLeaders.length > 0) {
            const idx = Math.floor(Math.random() * allLeaders.length);
            currentView.push(allLeaders[idx]);
            allLeaders.splice(idx, 1);
        }
        // 1 Base
        if(allBases.length > 0) {
            const idx = Math.floor(Math.random() * allBases.length);
            currentView.push(allBases[idx]);
            allBases.splice(idx, 1);
        }
        // 14 Units (Standard Booster size)
        for(let k=0; k<14; k++) {
            if(allUnits.length > 0) {
                const idx = Math.floor(Math.random() * allUnits.length);
                currentView.push(allUnits[idx]);
                allUnits.splice(idx, 1);
            }
        }
    }
    
    renderBoard();
}

// --- RENDER BOARD MED SORTERING ---
function renderBoard() {
    COLUMNS.forEach(colName => {
        const el = document.getElementById(`list-${colName}`);
        if(el) el.innerHTML = '';
    });

    const map = {};
    currentView.forEach(c => {
        const key = `${c.id}_${c.column}`;
        if(map[key]) map[key].count++; else map[key] = {...c, count:1};
    });

    document.getElementById('s-total').innerText = currentView.length;

    // SORTERING: ASPECTS -> COST -> NAVN
    const sortedCards = Object.values(map).sort((a, b) => {
        // Sorter efter Aspect streng (alfabetisk)
        if (a.aspects < b.aspects) return -1;
        if (a.aspects > b.aspects) return 1;
        // Derefter Cost
        if (a.cost < b.cost) return -1;
        if (a.cost > b.cost) return 1;
        // Derefter Navn
        return a.name.localeCompare(b.name);
    });

    sortedCards.forEach(c => {
        const list = document.getElementById(`list-${c.column}`);
        const target = list || document.getElementById('list-Pool'); 
        
        const cardEl = document.createElement('div');
        cardEl.className = `card-item`;
        cardEl.draggable = true;
        
        cardEl.ondragstart = (e) => {
            const payload = JSON.stringify({id: c.id, set: c.set, oldColumn: c.column});
            e.dataTransfer.setData("text/plain", payload);
            e.dataTransfer.effectAllowed = "copyMove";
        };
        
        cardEl.onclick = (e) => { if(e.target.tagName !== 'DIV') openModal(c); };
        
        cardEl.onmouseenter = (e) => showPreview(e, c.img, c.type); 
        cardEl.onmouseleave = hidePreview;
        cardEl.onmousemove = (e) => movePreview(e);

        const stackHtml = c.count > 1 ? `<div class="stack-badge">${c.count}</div>` : '';

        cardEl.innerHTML = `
            ${stackHtml}
            <img src="${c.img}" draggable="false">
            <div class="card-actions" onclick="addToDeck('${c.id}', '${c.set}', '${c.column}')">
                <div class="add-icon">+</div>
            </div>
        `;
        target.appendChild(cardEl);
    });
}

// --- DRAG HANDLERS ---
function handleDropOnBoard(e, newColumn) {
    e.preventDefault();
    document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));

    try {
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if(!data || !data.id) return;
        
        if(data.oldColumn === newColumn) return;

        const idx = currentView.findIndex(c => c.id === data.id && c.set === data.set && c.column === data.oldColumn);
        
        if (idx > -1) {
            currentView[idx].column = newColumn; 
            renderBoard();
        }
    } catch (err) { console.error(err); }
}

function handleDropOnDeck(e) {
    e.preventDefault();
    document.getElementById('sidebar').classList.remove('drag-over-deck');
    try {
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if(!data || !data.id) return;
        addToDeck(data.id, data.set, data.oldColumn);
    } catch (err) { console.error(err); }
}

// --- DECK MANAGEMENT ---
function addToDeck(id, setCode, fromColumn) {
    const idx = currentView.findIndex(c => c.id === id && c.set === setCode && c.column === fromColumn);
    if (idx === -1) return;

    const card = currentView[idx];
    currentView.splice(idx, 1); 

    const key = `${card.set}_${card.id}`;
    if(myDeck[key]) myDeck[key].count++;
    else myDeck[key] = { ...card, count: 1 }; 
    
    renderBoard();
    updateSidebar();
    showToast(`Tilføjet: ${card.name}`);
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;

    const cardFromDeck = myDeck[key];
    cardFromDeck.count--;
    if(cardFromDeck.count <= 0) delete myDeck[key];

    const targetCol = cardFromDeck.column || "Pool";

    const poolCard = { 
        id: cardFromDeck.id, 
        set: cardFromDeck.set, 
        name: cardFromDeck.name, 
        type: cardFromDeck.type,
        cost: cardFromDeck.cost,
        aspects: cardFromDeck.aspects,
        column: targetCol,
        img: cardFromDeck.img,
        uid: `${cardFromDeck.id}-returned-${Date.now()}` 
    };
    currentView.push(poolCard);

    renderBoard();
    updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    
    const deckArr = Object.values(myDeck).sort((a,b) => {
        if(a.type === 'Leader' && b.type !== 'Leader') return -1;
        if(a.type !== 'Leader' && b.type === 'Leader') return 1;
        if(a.type === 'Base' && b.type !== 'Base') return -1;
        if(a.type !== 'Base' && b.type === 'Base') return 1;
        return a.name.localeCompare(b.name);
    });

    deckArr.forEach(c => {
        sum += c.count;
        const li = document.createElement('li');
        let colorVar = '--c-unit';
        if(c.type === 'Leader') colorVar = '--c-leader';
        if(c.type === 'Base') colorVar = '--c-base';
        
        li.style.borderLeftColor = `var(${colorVar})`;
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent); font-weight:bold;">${c.count}</span>`;
        
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        
        li.onmouseenter = (e) => showPreview(e, c.img, c.type);
        li.onmouseleave = hidePreview;
        li.onmousemove = (e) => movePreview(e);

        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
}

function clearDeck() { 
    Object.values(myDeck).forEach(c => {
        for(let i=0; i<c.count; i++) {
             currentView.push({ 
                id: c.id, set: c.set, name: c.name, type: c.type, 
                cost: c.cost, aspects: c.aspects,
                column: c.column || "Pool",
                img: c.img,
                uid: `returned-${i}`
            });
        }
    });
    myDeck = {}; 
    renderBoard();
    updateSidebar(); 
}

// --- PREVIEW & TOOLTIPS ---
const tooltip = document.getElementById('preview-tooltip');

function showPreview(e, imgSrc, type) {
    tooltip.innerHTML = `<img src="${imgSrc}">`;
    
    if (type === 'Leader' || type === 'Base') {
        tooltip.classList.add('big-preview');
    } else {
        tooltip.classList.remove('big-preview');
    }

    tooltip.style.display = 'block';
    movePreview(e);
}

function movePreview(e) {
    const w = window.innerWidth;
    let tooltipW = 320;
    if (tooltip.classList.contains('big-preview')) {
        tooltipW = 600; 
    }
    
    let x = e.clientX + 20; 
    let y = e.clientY + 10;

    if (x + tooltipW > w) {
        x = e.clientX - tooltipW - 20;
    }

    const h = tooltip.offsetHeight || 400;
    const winH = window.innerHeight;
    if (y + h > winH) {
        y = winH - h - 20; 
    }

    tooltip.style.top = y + 'px';
    tooltip.style.left = x + 'px';
}

function hidePreview() { 
    tooltip.style.display = 'none'; 
}

// --- UTILS (JSON EXPORT) ---
function copyJSON() {
    const exportData = {
        metadata: {
            name: "Sealed Deck",
            author: "SWU Drafter"
        },
        leader: null,
        base: null,
        deck: [],
        sideboard: []
    };

    Object.values(myDeck).forEach(c => {
        const formattedId = `${c.set}_${c.id}`;
        const entry = { id: formattedId, count: c.count };

        if(c.type === 'Leader') {
            exportData.leader = entry;
        } else if(c.type === 'Base') {
            exportData.base = entry;
        } else {
            exportData.deck.push(entry);
        }
    });

    const str = JSON.stringify(exportData, null, 2);
    
    const el = document.createElement('textarea');
    el.value = str;
    el.setAttribute('readonly', '');
    el.style.position = 'absolute'; el.style.left = '-9999px';
    document.body.appendChild(el);
    el.select();
    try {
        document.execCommand('copy');
        playAudio('snd-copy');
        showToast("JSON Kopieret!");
    } catch (err) { alert("Fejl"); }
    document.body.removeChild(el);
}

function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.className = "show";
    setTimeout(() => t.className = t.className.replace("show", ""), 2000);
}

// --- MODAL & FLIP LOGIC ---
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modal-img');
const flipHint = document.getElementById('flip-hint');
let currentZoomCard = null;

function openModal(card) {
    currentZoomCard = card;
    modal.style.display = 'flex';
    
    if(card.type === 'Leader') {
        modalImg.src = card.imgFront;
        flipHint.style.display = 'block';
        document.getElementById('modal-flip-btn').style.display = 'block';
    } else {
        modalImg.src = card.img;
        flipHint.style.display = 'none';
        document.getElementById('modal-flip-btn').style.display = 'none';
    }
}

function flipLeader(e) {
    if(e) e.stopPropagation(); 
    if(!currentZoomCard || currentZoomCard.type !== 'Leader') return;
    
    const currentSrc = modalImg.src;
    // Tjekker om vi allerede viser unit siden (portrait)
    const isBack = currentSrc.includes("-portrait.png");

    if (isBack) {
        modalImg.src = currentZoomCard.imgFront;
    } else {
        modalImg.src = currentZoomCard.imgBack;
    }
}

function closeModal() { 
    modal.style.display = 'none'; 
}

// Init
initBoard();
</script>
</body>
</html>
"""

# --- 3. SKRIV DEN ENDELIGE FIL ---
final_html = html_template_start + json.dumps(db) + html_script_end

output_filename = "swu_drafter_ultimate.html"
with open(output_filename, "w", encoding="utf-8") as f:
    f.write(final_html)

print(f"SUCCES! Filen '{output_filename}' er oprettet med den komplette database og rettede leader-billeder.")
