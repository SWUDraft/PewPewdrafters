<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: Sealed Builder (Type Sort)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --accent: #FFE81F; 
            --accent-glow: rgba(255, 232, 31, 0.5);
            --text-main: #e0e0e0;
            --panel-bg: rgba(10, 12, 16, 0.9);
            --border-color: rgba(255, 255, 255, 0.15);
            
            --c-Aggression: #bd1e2d; --c-Command: #377d22; --c-Cunning: #f2c035;    
            --c-Vigilance: #006eb6; --c-Villainy: #222222; --c-Heroism: #eeeeee; --c-Neutral: #777777;

            --c-Common: #aaaaaa; --c-Uncommon: #55aaff; --c-Rare: #ffcc00;
            --c-Legendary: #aa55ff; --c-Special: #ff4444;
            --c-Foil: #0ff;
            
            /* TYPE COLORS */
            --c-Ground: #a0522d; --c-Space: #4682b4; --c-Event: #ffd700; --c-Upgrade: #c0c0c0;

            --c-leader: #fff; --c-base: #aaa; --c-unit: #444; --c-pool: #402020; 
        }

        body { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85)), 
                        url('https://www.stompinggroundstcg.com/cdn/shop/collections/Star_Wars_Unlimited_Collection_Banner_600x.webp?v=1722208792');
            background-size: cover;
            background-position: center top;
            background-attachment: fixed;
            color: var(--text-main); 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- HEADER --- */
        header { 
            padding: 0 30px; 
            background: rgba(0,0,0,0.85); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            display: flex; align-items: center; 
            height: 90px; z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,0.9); 
            position: relative;
        }
        
        .header-content {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        .left-group { display: flex; flex-direction: column; justify-content: center; align-items: flex-start; flex: 1; }
        .center-group { display: flex; gap: 20px; align-items: center; justify-content: center; flex: 2; }
        .right-group { display: flex; gap: 8px; justify-content: flex-end; align-items: center; flex: 1; }

        h1 { 
            margin: 0; font-family: 'Orbitron', sans-serif; color: var(--accent); 
            font-size: 22px; font-weight: 900; letter-spacing: 2px;
            text-shadow: 0 0 10px var(--accent-glow); text-transform: uppercase; 
            white-space: nowrap; padding-bottom: 2px;
        }
        .sub-stat { font-size: 10px; color: #aaa; font-family: 'Orbitron'; letter-spacing: 1px; margin-top: 6px; }
        .sub-stat span { color: #fff; font-weight: bold; }

        select, input[type="number"] { 
            background: rgba(10, 10, 15, 0.9); color: #fff; 
            border: 1px solid #444; padding: 0 10px; 
            font-family: 'Orbitron'; font-size: 13px; border-radius: 0; 
            outline: none; transition: 0.3s; height: 36px;
        }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        input[type="number"] { width: 55px; text-align: center; font-weight: bold; color: var(--accent); }
        
        button.btn, a.btn { 
            background: rgba(255,255,255,0.05); 
            color: #ddd; border: 1px solid #555; 
            padding: 0 18px; height: 36px; 
            font-family: 'Orbitron'; cursor: pointer; transition: all 0.2s ease-in-out; 
            border-radius: 0; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
        }
        button.btn:hover, a.btn:hover { 
            border-color: var(--accent); color: #fff; 
            background: rgba(255, 232, 31, 0.1); 
            box-shadow: 0 0 15px var(--accent-glow); transform: translateY(-1px); 
        }
        button.btn:active { transform: translateY(1px); }
        button.btn-action { border-color: var(--accent); color: var(--accent); background: rgba(255, 232, 31, 0.05); }
        
        .sound-btn { width: 40px; padding: 0; font-size: 18px; }
        button.btn-pew { border-color: #ff3333; color: #ff3333; background: rgba(255, 51, 51, 0.05); }
        button.btn-pew:hover { background: rgba(255, 51, 51, 0.2); box-shadow: 0 0 20px #ff3333; border-color: #ff3333; color: white; }
        button.btn-chewie { border-color: #8B4513; color: #8B4513; background: rgba(139, 69, 19, 0.1); }
        button.btn-chewie:hover { background: rgba(139, 69, 19, 0.3); box-shadow: 0 0 20px #8B4513; border-color: #A0522D; color: #fff; }
        button.btn-r2 { border-color: #00e5ff; color: #00e5ff; background: rgba(0, 229, 255, 0.05); }
        button.btn-r2:hover { background: rgba(0, 229, 255, 0.2); box-shadow: 0 0 20px #00e5ff; border-color: #fff; color: #fff; }
        
        .btn-save { background: #131; border-color: #252; color: #ada; width: 48%; }
        .btn-load { background: #113; border-color: #225; color: #aad; width: 48%; }
        .btn-karabast { background: #112; border-color: #338; color: #aaf; width: 48%; }
        .btn-karabast:hover { background: #224; border-color: #55f; color: #fff; box-shadow: 0 0 15px #55f; }
        
        .segment-control { display: flex; background: #000; border: 1px solid #444; border-radius: 0; overflow: hidden; height: 36px; }
        .segment-btn { padding: 0 14px; cursor: pointer; font-family: 'Orbitron'; font-size: 12px; color: #777; transition: 0.2s; border:none; background: transparent; border-right: 1px solid #333; height: 100%; }
        .segment-btn:last-child { border-right: none; }
        .segment-btn:hover { color: #fff; background: #151515; }
        .segment-btn.active { background: var(--accent); color: #000; font-weight: bold; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }

        #db-status { font-size: 10px; color: #777; font-family: monospace; border: 1px solid #333; padding: 2px 6px; border-radius: 4px; background: #111; }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }
        #board { flex: 1; display: flex; gap: 12px; padding: 20px; overflow-x: auto; align-items: flex-start; }
        
        .column { 
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px; 
            display: flex; flex-direction: column; transition: all 0.3s ease; flex-shrink: 0; 
            height: 100%; min-width: 170px; width: 170px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); 
            overflow: hidden; position: relative; backdrop-filter: blur(5px);
        }
        .column.drag-over { background: rgba(40, 40, 40, 0.9); box-shadow: 0 0 25px var(--accent-glow); border-color: var(--accent); }
        .col-special { width: 220px; min-width: 220px; border: 1px solid #444; display: flex; align-items: center; }
        .col-pool { width: 190px; min-width: 190px; border: 1px solid #444; background: var(--panel-bg); }

        .column.collapsed { min-width: 40px; width: 40px; background: #050505; border-color: #333; }
        .column.collapsed .col-content { display: none; }
        .column.collapsed .col-header { height: 100%; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); display: flex; align-items: center; justify-content: center; padding: 0; }
        .column.collapsed .header-title { margin-bottom: 10px; font-size: 14px; letter-spacing: 2px; }
        .column.collapsed .col-toggle { transform: rotate(90deg); margin-bottom: 10px; }

        .col-header { 
            width: 100%; padding: 10px; display: flex; justify-content: space-between; align-items: center;
            font-family: 'Orbitron'; font-weight: 900; font-size: 18px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); text-transform: uppercase; 
            background: rgba(0,0,0,0.4); z-index: 20; position: relative;
            letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); box-sizing: border-box;
        }
        
        .btn-mini { font-size: 9px; padding: 2px 6px; border: 1px solid #555; background: #222; color: #aaa; border-radius: 0; margin-left: auto; margin-right: 5px; cursor: pointer; font-family: 'Orbitron'; z-index: 100; }
        .btn-mini:hover { background: var(--accent); color: #000; border-color: var(--accent); }

        .col-toggle { background: transparent; border: 1px solid #555; color: #777; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 16px; line-height: 1; transition: 0.2s; }
        .col-toggle:hover { border-color: var(--accent); color: var(--accent); background: #222; }
        
        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); }
        .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); }
        .ch-Pool { border-bottom-color: #888; color: #ddd; }
        .ch-Aggression { border-bottom-color: var(--c-Aggression); color: var(--c-Aggression); }
        .ch-Command { border-bottom-color: var(--c-Command); color: var(--c-Command); }
        .ch-Cunning { border-bottom-color: var(--c-Cunning); color: var(--c-Cunning); }
        .ch-Vigilance { border-bottom-color: var(--c-Vigilance); color: var(--c-Vigilance); }
        .ch-Villainy { border-bottom-color: var(--c-Villainy); color: #999; }
        .ch-Heroism { border-bottom-color: var(--c-Heroism); color: #fff; }
        .ch-Neutral { border-bottom-color: var(--c-Neutral); color: #bbb; }
        .ch-Common { border-bottom-color: var(--c-Common); color: var(--c-Common); }
        .ch-Uncommon { border-bottom-color: var(--c-Uncommon); color: var(--c-Uncommon); }
        .ch-Rare { border-bottom-color: var(--c-Rare); color: var(--c-Rare); }
        .ch-Legendary { border-bottom-color: var(--c-Legendary); color: var(--c-Legendary); }
        .ch-Special { border-bottom-color: var(--c-Special); color: var(--c-Special); }
        .ch-cost { border-bottom-color: #666; color: #fff; font-size: 24px; }

        /* NEW TYPE HEADER COLORS */
        .ch-Ground { border-bottom-color: var(--c-Ground); color: #d88; }
        .ch-Space { border-bottom-color: var(--c-Space); color: #88d; }
        .ch-Event { border-bottom-color: var(--c-Event); color: #dd8; }
        .ch-Upgrade { border-bottom-color: var(--c-Upgrade); color: #ddd; }

        .col-content { width: 100%; flex: 1; overflow-y: auto; overflow-x: visible; padding: 15px 8px 250px 8px; display: flex; flex-direction: column; align-items: center; scrollbar-width: thin; scrollbar-color: #444 #111; position: relative; z-index: 10; box-sizing: border-box; }
        #list-Cards { display: grid; grid-template-columns: 1fr; gap: 8px; align-content: start; align-items: center; }

        /* --- SIDEBAR --- */
        #sidebar { width: 340px; background: rgba(10, 10, 12, 0.95); border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 4000; transition: all 0.2s; position: relative; flex-shrink: 0; box-shadow: -10px 0 40px rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .sb-header { padding: 15px; background: rgba(20,20,20,0.8); border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); font-size: 16px; letter-spacing: 2px; text-align: center; text-shadow: 0 0 10px rgba(255,232,31,0.3); }
        
        #stats-panel { padding: 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #333; }
        #mana-curve { display: flex; align-items: flex-end; height: 120px; gap: 6px; margin-bottom: 15px; border-bottom: 2px solid #555; border-left: 2px solid #555; padding: 0 10px 5px 10px; background: rgba(0,0,0,0.2); }
        .mc-bar-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; height: 100%; }
        .mc-val { font-size: 11px; color: #fff; margin-bottom: 4px; font-weight: bold; text-shadow: 0 1px 3px #000; }
        .mc-bar { width: 100%; background: linear-gradient(to top, #a70 0%, var(--accent) 100%); min-height: 4px; border-radius: 4px 4px 0 0; transition: height 0.3s ease-out; opacity: 1; box-shadow: inset 0 -2px 5px rgba(0,0,0,0.5), 0 0 10px var(--accent-glow); border: 1px solid #ffe81f77; border-bottom: none; }
        .mc-bar:hover { filter: brightness(1.2); }
        .mc-label { font-size: 11px; color: #aaa; margin-top: 6px; font-family: 'Orbitron'; font-weight: bold; }
        .arena-stats { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; font-family: 'Orbitron'; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .as-item span { color: var(--accent); font-weight: bold; font-size: 14px; }

        #deck-list { flex: 1; overflow-y: auto; padding: 15px; list-style: none; margin: 0; }
        #deck-list li { background: rgba(255,255,255,0.03); padding: 8px 12px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #555; font-size: 13px; border-radius: 2px; cursor: pointer; transition: all 0.1s; }
        #deck-list li:hover { background: rgba(255,232,31,0.1); color: #fff; transform: translateX(4px); border-left-color: var(--accent) !important; }
        
        .sb-footer { padding: 15px; border-top: 1px solid #333; background: rgba(0,0,0,0.8); }
        .save-load-container { display: flex; justify-content: space-between; margin-bottom: 10px; }

        #base-picker-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 8000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(8px); }
        #base-picker-content { background: #151515; border: 1px solid #444; padding: 30px; border-radius: 12px; width: 80%; max-width: 1000px; max-height: 80vh; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .picker-card { cursor: pointer; transition: 0.2s; position: relative; }
        .picker-card:hover { transform: scale(1.1); z-index: 10; }
        .picker-card img { width: 100%; border-radius: 8px; display: block; box-shadow: 0 5px 15px #000; }
        .picker-card:hover img { outline: 3px solid var(--accent); box-shadow: 0 0 25px var(--accent-glow); }

        .card-item { position: relative; background: #000; border-radius: 9px; cursor: grab; box-shadow: 0 4px 12px rgba(0,0,0,0.8); transition: transform 0.1s ease-out, margin 0.3s ease; display: flex; flex-direction: column; width: 100%; z-index: 1; will-change: transform; border: 1px solid #333; overflow: visible; }
        .card-item.foil { border: none; box-shadow: 0 0 15px 2px var(--c-Foil); animation: foil-pulse 3s infinite alternate; }
        @keyframes foil-pulse { 0% { box-shadow: 0 0 8px 1px var(--c-Foil); } 100% { box-shadow: 0 0 20px 5px var(--c-Foil); } }
        .card-item:hover { transform: scale(1.15); z-index: 1000 !important; box-shadow: 0 0 25px rgba(255, 232, 31, 0.4); border-color: var(--accent); }
        .card-item img { width: 100%; height: auto; display: block; border-radius: 9px; pointer-events: none; position: relative; z-index: 1; }
        .card-actions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; border-radius: 9px; backdrop-filter: blur(2px); z-index: 5; }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 30px; color: var(--accent); font-weight: 900; pointer-events: none; background: rgba(0,0,0,0.8); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .stack-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #000; width: 26px; height: 26px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: 900; border: 2px solid #000; z-index: 10; box-shadow: 2px 2px 5px #000; }

        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; }
        #upload-zone { border: 2px dashed #555; padding: 40px; border-radius: 10px; background: #222; margin-top: 20px; }
        #preview-tooltip { position: fixed; display: none; z-index: 6000; pointer-events: none; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; }
        #preview-tooltip img { width: 340px; display: block; }
        #preview-tooltip.big-preview img { width: auto; height: 65vh; max-width: none; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:7000; justify-content:center; align-items:center; flex-direction: column; }
        .modal-leader-wrapper { display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .modal-leader-card { text-align: center; }
        .modal-leader-card h3 { font-family: 'Orbitron'; font-size: 16px; letter-spacing: 2px; margin-bottom: 10px; }
        .modal-leader-wrapper img { max-width: 40vw; max-height: 80vh; border-radius: 15px; box-shadow: 0 0 30px #000; border: 2px solid #333; transition: 0.3s; }
        #modal-img-single { max-width:90vw; max-height:80vh; border-radius: 12px; display: block; box-shadow: 0 0 50px #000; border: 2px solid #333; }
        #toast { visibility: hidden; min-width: 200px; background-color: #222; color: var(--accent); text-align: center; border-radius: 4px; padding: 15px; position: fixed; z-index: 8000; left: 50%; bottom: 40px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent); box-shadow: 0 0 20px rgba(0,0,0,0.8); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h1 style="color:var(--accent); font-family:'Orbitron'; font-size: 30px;">SYSTEM INITIALIZING</h1>
        <p id="loading-text" style="font-family:'Rajdhani'; font-size:20px; color:#ccc;">Connecting to Database...</p>
        <div id="upload-zone" style="display:none;">
            <p style="color:#e55; font-weight:bold; font-family:'Orbitron'">DATABASE NOT FOUND</p>
            <p style="margin-bottom:15px;">Please upload 'swu_komplet_database.csv' manually:</p>
            <input type="file" onchange="handleFileSelect(this.files)" accept=".csv" style="background:#333; color:#fff;">
        </div>
    </div>

    <header>
        <div class="header-content">
            <div class="left-group">
                <h1>SWU SEALED BUILDER</h1>
                <div class="sub-stat">STATUS: <span id="db-status">DB: 0</span> | CARDS: <span id="s-total" style="color:#fff;">0</span></div>
            </div>

            <div class="center-group">
                <select id="setSelect">
                    <option value="TWI">Twilight of the Republic (TWI)</option>
                    <option value="JTL">Jump to Lightspeed (JTL)</option>
                    <option value="LOF">Legends of the Force (LOF)</option>
                    <option value="SEC">Secrets of Power (SEC)</option>
                    <option value="SOR">Spark of Rebellion (SOR)</option>
                    <option value="SHD">Shadows of the Galaxy (SHD)</option>
                </select>
                
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="packCount" value="6" min="1" max="24" title="Packs">
                    <button class="btn btn-action" onclick="openPacks()">OPEN</button>
                </div>
                
                <div class="segment-control">
                    <button class="segment-btn active" onclick="setSort('cost')">123</button>
                    <button class="segment-btn" onclick="setSort('aspect')">üé®</button>
                    <button class="segment-btn" onclick="setSort('rarity')">‚òÖ</button>
                    <button class="segment-btn" onclick="setSort('type')">TYPE</button>
                </div>
            </div>
            
            <div class="right-group">
                <button class="btn btn-chewie sound-btn" onclick="playAudio('snd-chewie')">üêª</button>
                <button class="btn btn-r2 sound-btn" onclick="playAudio('snd-r2d2')">ü§ñ</button>
                <button class="btn btn-pew sound-btn" onclick="playAudio('snd-pew-real')">üî´</button>
            </div>
        </div>
    </header>

    <div id="main-area">
        <div id="board"></div>
        <div id="sidebar">
            <div class="sb-header">YOUR DECK (<span id="deck-count">0</span>)</div>
            
            <div id="stats-panel">
                <div id="mana-curve"></div>
                <div class="arena-stats">
                    <div class="as-item">GROUND: <span id="stat-ground">0</span></div>
                    <div class="as-item">SPACE: <span id="stat-space">0</span></div>
                </div>
            </div>

            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <div class="save-load-container">
                    <button class="btn btn-save" onclick="saveDeck()">SAVE DECK</button>
                    <button class="btn btn-load" onclick="loadDeck()">LOAD DECK</button>
                </div>
                <div style="display:flex; gap:5px; margin-bottom:8px;">
                    <button class="btn" style="width:50%" onclick="copyJSON()">COPY JSON</button>
                    <a href="https://karabast.net/decks" target="_blank" class="btn btn-karabast" onclick="playAudio('snd-anakin')">GO TO KARABAST</a>
                </div>
                <button class="btn" style="width:100%; background:#422; border-color:#844; color:#f99;" onclick="clearDeck()">CLEAR DECK</button>
            </div>
        </div>
    </div>

    <div id="base-picker-modal" onclick="this.style.display='none'">
        <h2 style="color:var(--accent); font-family:'Orbitron'; margin-bottom: 20px; text-shadow: 0 0 10px var(--accent);">SELECT A COMMON BASE</h2>
        <div id="base-picker-content" onclick="event.stopPropagation()"></div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div id="modal-content"></div>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">COPIED TO CLIPBOARD!</div>
    
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>
    <audio id="snd-pew-real" src="https://www.myinstants.com/media/sounds/pew.mp3" preload="auto"></audio>
    <audio id="snd-palpatine" src="https://www.myinstants.com/media/sounds/palpatine-no-you-will-die-28468.mp3" preload="auto"></audio>
    <audio id="snd-anakin" src="https://www.myinstants.com/media/sounds/anakin-then-your-my-enemy-17918.mp3" preload="auto"></audio>
    <audio id="snd-chewie" src="https://www.myinstants.com/media/sounds/chewbacca.mp3" preload="auto"></audio>
    <audio id="snd-r2d2" src="https://www.myinstants.com/media/sounds/r2d2-scream.mp3" preload="auto"></audio>

<script>
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism", "Neutral"];
const RARITY_COLS = ["Common", "Uncommon", "Rare", "Legendary", "Special"];
const TYPE_COLS = ["Ground", "Space", "Event", "Upgrade"];

// --- HARDCODED FALLBACK FOR LOF BASES ---
const LOF_MISSING_BASES = [
    {id: '019', set: 'LOF', name: 'Vergence Temple', rarity: 'Rare', aspect: 'Vigilance', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/019.png'},
    {id: '020', set: 'LOF', name: 'Nightsister Lair', rarity: 'Common', aspect: 'Vigilance', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/020.png'},
    {id: '021', set: 'LOF', name: 'Shadowed Undercity', rarity: 'Common', aspect: 'Vigilance', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/021.png'},
    {id: '022', set: 'LOF', name: 'Mystic Monastery', rarity: 'Rare', aspect: 'Command', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/022.png'},
    {id: '023', set: 'LOF', name: 'Jedi Temple', rarity: 'Common', aspect: 'Command', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/023.png'},
    {id: '024', set: 'LOF', name: 'Starlight Temple', rarity: 'Common', aspect: 'Command', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/024.png'},
    {id: '025', set: 'LOF', name: 'Temple of Destruction', rarity: 'Rare', aspect: 'Aggression', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/025.png'},
    {id: '026', set: 'LOF', name: 'Fortress Vader', rarity: 'Common', aspect: 'Aggression', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/026.png'},
    {id: '027', set: 'LOF', name: 'Strangled Cliffs', rarity: 'Common', aspect: 'Aggression', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/027.png'},
    {id: '028', set: 'LOF', name: 'Tomb of Eilram', rarity: 'Rare', aspect: 'Cunning', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/028.png'},
    {id: '029', set: 'LOF', name: 'Crystal Caves', rarity: 'Common', aspect: 'Cunning', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/029.png'},
    {id: '030', set: 'LOF', name: 'The Holy City', rarity: 'Common', aspect: 'Cunning', type: 'Base', img: 'https://swudb.com/cdn-cgi/image/quality=95/images/cards/LOF/030.png'}
];

let myDeck = {}, currentView = [], currentSortMode = 'cost';
let LOCAL_DATABASE = {};
let viewLeaderBack = false; 
let appMode = 'sealed'; 

window.onload = function() {
    fetch('swu_komplet_database.csv')
        .then(r => { if(!r.ok) throw new Error("404"); return r.text(); })
        .then(d => parseCSVandInstall(d))
        .catch(e => {
            const s = localStorage.getItem('SWU_DB');
            if (s) { 
                LOCAL_DATABASE = JSON.parse(s); 
                ensureLOFBases(LOCAL_DATABASE); 
                updateDBStatus();
                document.getElementById('loading-overlay').style.display = 'none'; 
                initBoard(); 
            } 
            else {
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('upload-zone').style.display = 'block';
            }
        });
};

function handleFileSelect(files) {
    if(!files[0]) return;
    const r = new FileReader();
    r.onload = e => parseCSVandInstall(e.target.result);
    r.readAsText(files[0]);
}

function ensureLOFBases(db) {
    if (!db['LOF']) db['LOF'] = {leaders:[], bases:[], deck:[]};
    const existing = db['LOF'].bases;
    LOF_MISSING_BASES.forEach(base => {
        if (!existing.find(b => b.id === base.id)) {
            db['LOF'].bases.push(base);
        }
    });
}

function parseCSVandInstall(csvText) {
    const rows = [];
    let currentRow = [];
    let currentVal = '';
    let insideQuote = false;
    let firstLineEnd = csvText.indexOf('\n');
    if(firstLineEnd === -1) firstLineEnd = csvText.length;
    const firstLine = csvText.substring(0, firstLineEnd);
    const delim = firstLine.includes(';') ? ';' : ',';

    for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i+1];
        if (char === '"') {
            if (insideQuote && nextChar === '"') { currentVal += '"'; i++; } 
            else { insideQuote = !insideQuote; }
        } else if (char === delim && !insideQuote) {
            currentRow.push(currentVal.trim()); currentVal = '';
        } else if ((char === '\n' || char === '\r') && !insideQuote) {
            if (char === '\r' && nextChar === '\n') i++;
            currentRow.push(currentVal.trim());
            if (currentRow.length > 1) rows.push(currentRow);
            currentRow = []; currentVal = '';
        } else { currentVal += char; }
    }
    if (currentRow.length > 1) rows.push(currentRow);

    if(rows.length < 2) { alert("File seems empty or invalid format."); return; }
    
    const h = rows[0];
    const m = {}; 
    h.forEach((v,i) => m[v.replace(/^"|"$/g, '').trim()] = i); 
    
    let idIdx = -1, costIdx = -1, setIdx = -1, typeIdx = -1;
    Object.keys(m).forEach(k => {
        if(k.includes('Card ID')) idIdx = m[k];
        if(k === 'Cost') costIdx = m[k];
        if(k.includes('Source')) setIdx = m[k];
        if(k.includes('Type')) typeIdx = m[k];
    });

    if(idIdx === -1 || costIdx === -1) {
        alert("Error: Missing 'Card ID' or 'Cost' columns.");
        return;
    }

    const setMap = {'TWL': 'TWI', 'SOR': 'SOR', 'SHD': 'SHD', 'JTL': 'JTL', 'LOF': 'LOF', 'SEC': 'SEC'};
    const db = {};
    let count = 0;

    for(let i=1; i<rows.length; i++) {
        const row = rows[i];
        if(row.length < h.length) continue;
        
        const rawSet = row[setIdx];
        if(!setMap[rawSet]) continue;
        const setCode = setMap[rawSet];

        const id = row[idIdx].split('.')[0].padStart(3, '0');
        const intId = parseInt(id);
        
        if (setCode === 'LOF' && intId >= 19 && intId <= 30) {
            continue; 
        }

        const name = row[m['Card Name']];
        const typeRaw = row[typeIdx] || "Unit";
        const arenaRaw = row[m['Arena']] || "";
        const cost = parseInt(row[costIdx]) || 0;
        
        let rarVal = row[m['Rarity']] ? row[m['Rarity']].trim().toUpperCase() : "C";
        if(rarVal.length > 0) rarVal = rarVal.charAt(0);
        let rarity = "Common";
        if(rarVal === 'U') rarity = "Uncommon";
        else if(rarVal === 'R') rarity = "Rare";
        else if(rarVal === 'L') rarity = "Legendary";
        else if(rarVal === 'S') rarity = "Special";

        const a1 = row[m['Aspect(s)']] || "";
        const a2 = row[m['Unnamed: 12']] || ""; 
        let asp = "Neutral"; 
        const mainAspects = ["Aggression", "Command", "Cunning", "Vigilance"];
        const isMain = (a) => mainAspects.includes(a);
        const isAlign = (a) => a === "Villainy" || a === "Heroism";
        if (isMain(a1)) asp = a1; else if (isMain(a2)) asp = a2;
        else if (isAlign(a1)) asp = a1; else if (isAlign(a2)) asp = a2;

        const img = `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${id}.png`;
        
        let simpleType = "Unit";
        
        // PALPATINE & JABBA FIX
        if (name.includes('Emperor Palpatine') && setCode === 'SOR' && intId === 135) {
            simpleType = "Leader";
        } else if (name.includes('Jabba the Hutt') && setCode === 'SEC') {
            simpleType = "Leader";
        } else {
            if(typeRaw.includes('Leader')) simpleType = "Leader";
            else if(typeRaw.includes('Base')) simpleType = "Base";
            else if(typeRaw.includes('Event')) simpleType = "Event";
            else if(typeRaw.includes('Upgrade')) simpleType = "Upgrade";
        }
        
        let arena = "None";
        if(arenaRaw.includes("Ground")) arena = "Ground";
        else if(arenaRaw.includes("Space")) arena = "Space";

        const cardObj = { id, set: setCode, name, cost: cost.toString(), aspect: asp, rarity: rarity, img, type: simpleType, arena: arena };

        if(!db[setCode]) db[setCode] = {leaders:[], bases:[], deck:[]};
        
        if(simpleType === 'Leader') { 
            if(setCode === 'TWI' || setCode === 'SOR' || setCode === 'SHD' || setCode === 'SEC' || setCode === 'LOF' || setCode === 'JTL') {
                cardObj.back = `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${id}-portrait.png`;
            } else {
                cardObj.back = `https://swudb.com/cdn-cgi/image/quality=95/images/cards/${setCode}/${id}-back.png`; 
            }
            db[setCode].leaders.push(cardObj); 
        }
        else if(simpleType === 'Base') db[setCode].bases.push(cardObj);
        else db[setCode].deck.push(cardObj); 
        
        count++;
    }

    ensureLOFBases(db);

    LOCAL_DATABASE = db;
    updateDBStatus();
    try { localStorage.setItem('SWU_DB', JSON.stringify(db)); } catch(e){}
    document.getElementById('loading-overlay').style.display = 'none';
    initBoard();
}

function updateDBStatus() {
    let c = 0;
    Object.values(LOCAL_DATABASE).forEach(s => { c += s.deck.length + s.leaders.length + s.bases.length; });
    document.getElementById('db-status').innerText = `DB: ${c} CARDS`;
    document.getElementById('db-status').style.color = c > 0 ? '#0a0' : '#f55';
}

function getCostColumn(c) { const v=parseInt(c); if(isNaN(v)||v<=1)return "1"; if(v>=8)return "8"; return v.toString(); }
function getSetData(sc) { return (LOCAL_DATABASE[sc]&&LOCAL_DATABASE[sc].deck.length) ? LOCAL_DATABASE[sc] : {leaders:[],bases:[],deck:[]}; }

function resetDatabase() {
    if(confirm("Reset Database and reload?")) {
        localStorage.removeItem('SWU_DB');
        location.reload();
    }
}

// --- SORT ---
function setSort(mode) {
    currentSortMode = mode;
    const btns = document.querySelectorAll('.segment-btn');
    btns.forEach(b => b.classList.remove('active'));
    
    const sortBtns = document.querySelectorAll('.segment-control')[0].children;
    if (mode === 'cost') sortBtns[0].classList.add('active');
    if (mode === 'aspect') sortBtns[1].classList.add('active');
    if (mode === 'rarity') sortBtns[2].classList.add('active');
    if (mode === 'type') sortBtns[3].classList.add('active');
    
    initBoard(); renderBoard();
}

// --- VISUAL BASE PICKER LOGIC ---
function showBasePicker() {
    const setCode = document.getElementById('setSelect').value;
    const d = getSetData(setCode);
    const modal = document.getElementById('base-picker-modal');
    const content = document.getElementById('base-picker-content');
    content.innerHTML = '';

    let pool = [];
    if(d.bases && d.bases.length > 0) {
        pool = d.bases.filter(b => b.rarity === 'Common');
    }
    if(pool.length === 0) {
        Object.values(LOCAL_DATABASE).forEach(s => {
            pool.push(...s.bases.filter(b => b.rarity === 'Common'));
        });
    }

    if(pool.length === 0) {
        content.innerHTML = "<p style='color:white'>No common bases found in database.</p>";
        modal.style.display = 'flex';
        return;
    }

    const uniqueBases = [];
    const map = new Map();
    for (const item of pool) {
        if(!map.has(item.name)){
            map.set(item.name, true);
            uniqueBases.push(item);
        }
    }
    uniqueBases.sort((a, b) => a.aspect.localeCompare(b.aspect));

    uniqueBases.forEach(b => {
        const el = document.createElement('div');
        el.className = 'picker-card';
        el.innerHTML = `<img src="${b.img}">`;
        el.onclick = () => {
            addBaseToDeck(b);
            modal.style.display = 'none';
        };
        content.appendChild(el);
    });
    
    modal.style.display = 'flex';
}

function addBaseToDeck(base) {
    Object.keys(myDeck).forEach(k => {
        if(myDeck[k].type === 'Base') delete myDeck[k];
    });
    const key = `${base.set}_${base.id}`;
    myDeck[key] = {...base, count: 1}; 
    updateSidebar();
    playAudio('snd-copy');
    const t = document.getElementById('toast'); 
    t.innerText = "BASE ADDED!";
    t.className = 'show'; 
    setTimeout(()=>t.className='', 2000);
}

// --- SEALED LOGIC (16 CARDS) ---
function openPacks() {
    const setCode = document.getElementById('setSelect').value;
    const count = parseInt(document.getElementById('packCount').value)||6;
    playAudio('snd-cantina');
    
    const d = getSetData(setCode);
    if(!d.deck.length) { alert(`No cards found for ${setCode}.`); return; }
    
    currentView = [];
    for(let i=0; i<count; i++) {
        if(d.leaders.length) currentView.push({...d.leaders[Math.floor(Math.random()*d.leaders.length)], uid:Date.now()+i+'l', column:'Leader'});
        if(d.bases.length) currentView.push({...d.bases[Math.floor(Math.random()*d.bases.length)], uid:Date.now()+i+'b', column:'Base'});
        
        const rares = d.deck.filter(c => c.rarity === 'Rare' || c.rarity === 'Legendary');
        if (rares.length) {
             const c = rares[Math.floor(Math.random()*rares.length)];
             currentView.push({...c, uid:Date.now()+i+'r', column: getSortColumn(c)});
        }

        const uncommons = d.deck.filter(c => c.rarity === 'Uncommon');
        if (uncommons.length) {
            for(let u=0; u<3; u++) {
                const c = uncommons[Math.floor(Math.random()*uncommons.length)];
                currentView.push({...c, uid:Date.now()+i+u+'u', column: getSortColumn(c)});
            }
        }

        const commons = d.deck.filter(c => c.rarity === 'Common');
        if (commons.length) {
            for(let k=0; k<9; k++) {
                const c = commons[Math.floor(Math.random()*commons.length)];
                currentView.push({...c, uid:Date.now()+i+k+'c', column: getSortColumn(c)});
            }
        }
        
        if (d.deck.length) {
            const c = d.deck[Math.floor(Math.random()*d.deck.length)];
            currentView.push({...c, uid:Date.now()+i+'foil', column: getSortColumn(c), isFoil: true});
        }
    }
    renderBoard();
}

function getSortColumn(c) {
    if (currentSortMode === 'cost') return getCostColumn(c.cost);
    if (currentSortMode === 'rarity') return c.rarity;
    if (currentSortMode === 'aspect') return c.aspect;
    
    // TYPE SORT LOGIC
    if (currentSortMode === 'type') {
        if(c.type === 'Event') return 'Event';
        if(c.type === 'Upgrade') return 'Upgrade';
        if(c.arena === 'Space') return 'Space';
        return 'Ground';
    }
    return c.aspect; 
}

// --- BOARD & UI ---
function toggleCol(id) {
    const el = document.getElementById(id);
    const btn = el.querySelector('.col-toggle');
    el.classList.toggle('collapsed');
    btn.innerText = el.classList.contains('collapsed') ? '+' : '-';
}

function toggleLeaderSide() {
    viewLeaderBack = !viewLeaderBack;
    renderBoard();
}

function initBoard() {
    const b = document.getElementById('board'); b.innerHTML = '';
    let cols;
    
    if(currentSortMode === 'cost') cols = ["Leader", "Base", "Cards", ...COST_COLS];
    else if(currentSortMode === 'rarity') cols = ["Leader", "Base", "Cards", ...RARITY_COLS];
    else if(currentSortMode === 'type') cols = ["Leader", "Base", "Cards", ...TYPE_COLS];
    else cols = ["Leader", "Base", "Cards", ...ASPECT_COLS];
    
    cols.forEach(cn => {
        const c = document.createElement('div'); c.id = `col-${cn}`;
        c.className = 'column' + (cn==='Leader'||cn==='Base'?' col-special':cn==='Cards'?' col-pool':'');
        c.ondragover = e => { e.preventDefault(); c.classList.add('drag-over'); };
        c.ondragleave = e => c.classList.remove('drag-over');
        c.ondrop = e => handleDropOnBoard(e, cn);
        
        let hc = "ch-cost";
        if(cn==="Leader") hc="ch-Leader"; 
        else if(cn==="Base") hc="ch-Base"; 
        else if(cn==="Cards") hc="ch-Pool";
        else if(ASPECT_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(RARITY_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(TYPE_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(cn==="Neutral") hc="ch-Neutral";
        
        let extraBtn = '';
        if(cn === 'Leader') {
            extraBtn = `<button class="btn-mini" onclick="toggleLeaderSide()">FLIP</button>`;
        }
        if(cn === 'Base') {
            extraBtn = `<button class="btn-mini" onclick="showBasePicker()">ADD</button>`;
        }

        c.innerHTML = `<div class="col-header ${hc}">
            <span class="header-title">${cn}</span>
            ${extraBtn}
            <button class="col-toggle" onclick="toggleCol('col-${cn}')">-</button>
        </div><div class="col-content" id="list-${cn}"></div>`;
        b.appendChild(c);
    });
    const s = document.getElementById('sidebar');
    s.ondragover = e => { e.preventDefault(); s.classList.add('drag-over-deck'); };
    s.ondragleave = e => s.classList.remove('drag-over-deck');
    s.ondrop = e => handleDropOnDeck(e);
}

function renderBoard() {
    const allCols = ["Leader", "Base", "Cards", ...COST_COLS, ...ASPECT_COLS, ...RARITY_COLS, ...TYPE_COLS];
    allCols.forEach(cn => { const el=document.getElementById(`list-${cn}`); if(el) el.innerHTML=''; });

    if(currentView.length === 0) return;

    const map = {}; 
    currentView.forEach(c => {
        if(c.type!=='Leader' && c.type!=='Base' && c.column!=='Cards') {
             c.column = getSortColumn(c);
        }
        const k = `${c.id}_${c.column}`;
        if(map[k]) map[k].count++; else map[k] = {...c, count:1};
    });
    
    document.getElementById('s-total').innerText = currentView.length;

    Object.values(map).forEach(c => {
        const t = document.getElementById(`list-${c.column}`) || document.getElementById('list-Cards');
        if(!t) return;
        
        const el = document.createElement('div'); 
        el.className = `card-item`; 
        if (c.isFoil) el.classList.add('foil');
        
        el.draggable = true;
        el.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'board'}));
        el.onclick = e => { if(e.target.tagName!=='DIV') openModal(c); };
        el.oncontextmenu = e => { e.preventDefault(); addToDeck(c.id, c.set); }; 
        el.onmouseenter = e => showPreview(e,c.img,c.type); 
        el.onmouseleave = hidePreview; el.onmousemove = e => movePreview(e);
        
        const actionClick = `addToDeck('${c.id}','${c.set}')`;
        
        let imgSrc = c.img;
        if (c.type === 'Leader' && viewLeaderBack) {
            imgSrc = c.back || c.img.replace('.png', '-portrait.png');
        }

        el.innerHTML = (c.count>1 ?`<div class="stack-badge">${c.count}</div>`:'') + 
            `<img src="${imgSrc}" draggable="false"><div class="card-actions" onclick="${actionClick}"><div class="add-icon">+</div></div>`;
        t.appendChild(el);
    });
}

function addToDeck(id, set) {
    const idx = currentView.findIndex(c => c.id===id && c.set===set);
    if(idx===-1) return;
    const c = currentView[idx]; currentView.splice(idx, 1); 
    const k = `${c.set}_${c.id}`;
    if(myDeck[k]) myDeck[k].count++; else myDeck[k] = {...c, count:1}; 
    renderBoard(); updateSidebar();
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;
    const c = myDeck[key]; c.count--;
    if(c.count<=0) delete myDeck[key];
    currentView.push({...c, count:undefined, uid:Date.now(), column:'Cards'});
    renderBoard(); updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    let curveObj = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};
    let maxCount = 0;
    let groundCount = 0;
    let spaceCount = 0;

    Object.values(myDeck).sort((a,b) => {
        let cA = parseInt(a.cost)||0; let cB = parseInt(b.cost)||0;
        if(cA!==cB) return cA-cB;
        return a.name.localeCompare(b.name);
    }).forEach(c => {
        sum += c.count;
        if (c.type !== 'Leader' && c.type !== 'Base') {
            let cost = parseInt(c.cost);
            if (cost < 1) cost = 1; if (cost > 8) cost = 8;
            curveObj[cost] += c.count;
            if (curveObj[cost] > maxCount) maxCount = curveObj[cost];
            
            if(c.arena === 'Ground') groundCount += c.count;
            if(c.arena === 'Space') spaceCount += c.count;
        }

        const li = document.createElement('li');
        li.draggable = true;
        li.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'deck'}));
        li.style.borderLeftColor = (c.type==='Leader'?'#fff':c.type==='Base'?'#aaa':`var(--c-${c.aspect})`);
        
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent);font-weight:bold;">${c.count}</span>`;
        
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        li.oncontextmenu = e => { e.preventDefault(); removeFromDeck(`${c.set}_${c.id}`); }; 
        li.onmouseenter = e => showPreview(e, c.img, c.type);
        li.onmouseleave = hidePreview;
        li.onmousemove = e => movePreview(e);
        
        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
    
    const curveEl = document.getElementById('mana-curve'); curveEl.innerHTML = '';
    for (let i = 1; i <= 8; i++) {
        const count = curveObj[i];
        const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
        const label = i === 8 ? '8+' : i;
        curveEl.innerHTML += `
            <div class="mc-bar-col">
                <div class="mc-val">${count > 0 ? count : ''}</div>
                <div class="mc-bar" style="height:${height}%;"></div>
                <div class="mc-label">${label}</div>
            </div>`;
    }
    document.getElementById('stat-ground').innerText = groundCount;
    document.getElementById('stat-space').innerText = spaceCount;
}

function clearDeck() { 
    Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) currentView.push({...c, count:undefined, column:'Cards'}); }); 
    renderBoard(); 
    myDeck={}; updateSidebar(); 
}

function playAudio(id) { const s=document.getElementById(id); if(s){s.volume=0.4; s.currentTime=0; s.play().catch(e=>{});} }

function handleDropOnDeck(e) { 
    e.preventDefault(); document.getElementById('sidebar').classList.remove('drag-over-deck');
    try { const d=JSON.parse(e.dataTransfer.getData("text/plain")); if(d.source==='board') {
        addToDeck(d.id,d.set); 
    }} catch(e){} 
}
function handleDropOnBoard(e, cn) {
    e.preventDefault(); document.getElementById('col-'+cn).classList.remove('drag-over');
    try {
        const d = JSON.parse(e.dataTransfer.getData("text/plain"));
        if(d.source==='deck') {
            const k=`${d.set}_${d.id}`;
            if(myDeck[k]) {
                myDeck[k].count--; if(myDeck[k].count<=0) delete myDeck[k];
                const info = LOCAL_DATABASE[d.set].deck.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].leaders.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].bases.find(x=>x.id==d.id);
                if(info) currentView.push({...info, uid:Date.now(), column:cn});
                renderBoard(); updateSidebar();
            }
        } else if(d.source==='board') {
            const i = currentView.findIndex(c => c.id===d.id && c.set===d.set);
            if(i!==-1) { currentView[i].column=cn; renderBoard(); }
        }
    } catch(e){}
}

function copyJSON() { 
    const d = {
        metadata: {
            name: "Sealed Deck - SWU Drafter",
            author: "User"
        },
        leader: null,
        base: null,
        deck: [],
        sideboard: []
    };
    
    Object.values(myDeck).forEach(c => { 
        const setCode = c.set.toUpperCase();
        const paddedId = c.id.toString().padStart(3, '0');
        const pid = `${setCode}_${paddedId}`;
        
        const entry = {id: pid, count: c.count}; 
        
        if(c.type === 'Leader') {
             d.leader = entry; 
        } 
        else if(c.type === 'Base') { 
             d.base = entry; 
        } 
        else {
             d.deck.push(entry); 
        }
    });

    const el = document.createElement('textarea'); 
    el.value = JSON.stringify(d, null, 2); 
    document.body.appendChild(el); 
    el.select(); 
    document.execCommand('copy'); 
    document.body.removeChild(el); 
    
    playAudio('snd-palpatine');
    
    const t = document.getElementById('toast'); t.innerText = "JSON COPIED!";
    t.className = 'show'; setTimeout(()=>t.className='', 2000);
}

function saveDeck() {
    if (Object.keys(myDeck).length === 0) { alert("Deck is empty!"); return; }
    localStorage.setItem('SWU_SAVED_DECK', JSON.stringify(myDeck));
    const t = document.getElementById('toast'); t.innerText = "DECK SAVED!";
    t.className = 'show'; setTimeout(()=>t.className='', 2000);
}

function loadDeck() {
    const saved = localStorage.getItem('SWU_SAVED_DECK');
    if (!saved) { alert("No saved deck found!"); return; }
    if (Object.keys(myDeck).length > 0 && !confirm("Overwrite current deck?")) return;
    try {
        myDeck = JSON.parse(saved);
        renderBoard(); updateSidebar(); 
        const t = document.getElementById('toast'); t.innerText = "DECK LOADED!";
        t.className = 'show'; setTimeout(()=>t.className='', 2000);
    } catch(e) { alert("Error loading deck."); }
}

const tip = document.getElementById('preview-tooltip');
let isP = false, isT = false;
function showPreview(e,src,t) { 
    isP=true; 
    tip.innerHTML=`<img src="${src}">`; 
    tip.className=t==='Leader'||t==='Base'?'big-preview':''; 
    tip.style.display='block'; 
    reqUpd(e); 
}
function movePreview(e) { if(isP) reqUpd(e); }
function hidePreview() { isP=false; tip.style.display='none'; }
function reqUpd(e) { if(!isT) { requestAnimationFrame(()=>{ updPos(e); isT=false; }); isT=true; } }
function updPos(e) {
    const w=window.innerWidth, h=window.innerHeight;
    let x=e.clientX+20, y=e.clientY+10;
    const tipW=tip.className.includes('big')?600:320;
    if(x+tipW>w) x=e.clientX-tipW-20;
    if(y+(tip.offsetHeight||400)>h) y=h-(tip.offsetHeight||400)-20;
    tip.style.top=y+'px'; tip.style.left=x+'px';
}

const modal=document.getElementById('modal');
function openModal(c) {
    const content = document.getElementById('modal-content');
    modal.style.display = 'flex';
    if (c.type === 'Leader') {
        let backImg = c.back || c.img.replace('.png', '-back.png');
        if(c.set === 'TWI' || c.set === 'SOR' || c.set === 'SHD' || c.set === 'JTL') {
             backImg = c.img.replace('.png', '-portrait.png');
        }

        content.innerHTML = `
            <div class="modal-leader-wrapper">
                <div class="modal-leader-card"><h3 style="color:#aaa">FRONT</h3><img src="${c.img}" onclick="event.stopPropagation()"></div>
                <div class="modal-leader-card"><h3 style="color:var(--accent)">UNIT SIDE</h3><img src="${backImg}" onclick="event.stopPropagation()"></div>
            </div>`;
    } else {
        content.innerHTML = `<img id="modal-img-single" src="${c.img}" onclick="event.stopPropagation()">`;
    }
}
function closeModal() { modal.style.display='none'; }
</script>
</body>
</html>
