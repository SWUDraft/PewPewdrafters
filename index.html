<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: GitHub Drafter (Rarity & Neutral Fix)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #FFE81F; 
            --text-main: #e0e0e0;
            
            /* SWU Aspect Colors */
            --c-Aggression: #bd1e2d; 
            --c-Command: #377d22;    
            --c-Cunning: #f2c035;    
            --c-Vigilance: #006eb6;  
            --c-Villainy: #222222;   
            --c-Heroism: #eeeeee;
            --c-Neutral: #555555;

            /* Rarity Colors */
            --c-Common: #aaaaaa;
            --c-Uncommon: #55aaff;
            --c-Rare: #ffcc00;
            --c-Legendary: #aa55ff;
            --c-Special: #ff4444;

            /* Types */
            --c-leader: #fff; --c-base: #aaa; --c-unit: #444; --c-pool: #402020; 
            --success-green: #0a0;
        }

        body { background: var(--bg); color: var(--text-main); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { padding: 10px 20px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; height: 60px; z-index: 10; }
        h1 { margin: 0; font-family: 'Orbitron'; color: var(--accent); font-size: 18px; letter-spacing: 1px; margin-right: 15px; }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        select, input { background: #111; color: var(--accent); border: 1px solid #444; padding: 5px 10px; font-family: 'Orbitron'; font-size: 14px; border-radius: 4px; }
        input[type="number"] { width: 50px; text-align: center; }
        
        #searchInput { width: 150px; border-color: #666; color: #fff; }
        #searchInput:focus { border-color: var(--accent); outline: none; }

        button.btn { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; font-family: 'Orbitron'; cursor: pointer; transition: 0.2s; border-radius: 4px; font-size: 12px; text-transform: uppercase; }
        button.btn:hover { border-color: var(--accent); color: var(--accent); background: #000; }
        button.btn:disabled { color: #555; border-color: #333; cursor: wait; opacity: 0.7; }
        
        button.btn-pew { background: #822; border-color: #a44; color: #fff; font-weight: bold; }
        button.btn-pew:hover { background: #b33; border-color: #f66; color: #fff; transform: scale(1.1); }

        .stat { font-family: 'Orbitron'; font-size: 14px; color: #aaa; margin-right: 20px; }
        .stat span { color: var(--accent); }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; position: relative; }
        #board { flex: 1; display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat; align-items: flex-start; }
        #board::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: -1; pointer-events: none; }

        /* --- COLUMNS --- */
        .column { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; transition: all 0.2s; flex-shrink: 0; height: 100%; min-width: 150px; width: 150px; }
        .column.drag-over { background: rgba(60, 60, 60, 0.95); box-shadow: 0 0 25px var(--accent); border-color: var(--accent); }
        .col-special { width: 170px; min-width: 170px; border: 1px solid #555; }
        .col-pool { width: 180px; min-width: 180px; border: 1px solid #644; background: rgba(30, 20, 20, 0.9); }

        .col-header { padding: 8px; text-align: center; font-family: 'Orbitron'; font-weight: bold; font-size: 16px; border-bottom: 4px solid transparent; text-transform: uppercase; background: rgba(0,0,0,0.6); border-top-left-radius: 8px; border-top-right-radius: 8px; z-index: 5; }
        
        /* Header Colors */
        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); }
        .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); }
        .ch-Pool { border-bottom-color: var(--c-pool); color: #faa; }
        
        /* Aspect Colors */
        .ch-Aggression { border-bottom-color: var(--c-Aggression); color: var(--c-Aggression); }
        .ch-Command { border-bottom-color: var(--c-Command); color: var(--c-Command); }
        .ch-Cunning { border-bottom-color: var(--c-Cunning); color: var(--c-Cunning); }
        .ch-Vigilance { border-bottom-color: var(--c-Vigilance); color: var(--c-Vigilance); }
        .ch-Villainy { border-bottom-color: var(--c-Villainy); color: #999; }
        .ch-Heroism { border-bottom-color: var(--c-Heroism); color: #fff; }
        .ch-Neutral { border-bottom-color: var(--c-Neutral); color: #bbb; }

        /* Rarity Colors */
        .ch-Common { border-bottom-color: var(--c-Common); color: var(--c-Common); }
        .ch-Uncommon { border-bottom-color: var(--c-Uncommon); color: var(--c-Uncommon); }
        .ch-Rare { border-bottom-color: var(--c-Rare); color: var(--c-Rare); }
        .ch-Legendary { border-bottom-color: var(--c-Legendary); color: var(--c-Legendary); }
        .ch-Special { border-bottom-color: var(--c-Special); color: var(--c-Special); }
        
        .ch-cost { border-bottom-color: var(--c-unit); color: #fff; font-size: 20px; }

        .col-content { flex: 1; overflow-y: auto; overflow-x: visible; padding: 15px 10px 50px 10px; display: flex; flex-direction: column; align-items: center; }
        #list-Pool { display: grid; grid-template-columns: 1fr; gap: 5px; align-content: start; align-items: center; }

        /* --- SIDEBAR --- */
        #sidebar { width: 280px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 100; transition: all 0.2s; position: relative; flex-shrink: 0; }
        #sidebar.drag-over-deck { background: #1a1a1a; box-shadow: inset 0 0 20px var(--success-green); border-left: 2px solid var(--success-green); }
        .sb-header { padding: 15px; background: #181818; border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); }
        #deck-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        #deck-list li { background: #222; padding: 6px 10px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; font-size: 13px; border-radius: 3px; cursor: pointer; transition: background 0.2s; }
        #deck-list li:hover { background: #444; color: #fff; }
        .sb-footer { padding: 10px; border-top: 1px solid #333; background: #181818; }

        /* --- CARD ITEM --- */
        .card-item { 
            position: relative; background: #000; border-radius: 6px; cursor: grab; 
            box-shadow: 0 -2px 5px rgba(0,0,0,0.5); 
            transition: transform 0.1s ease-out;
            display: flex; flex-direction: column; width: 100%; z-index: 1; 
            will-change: transform; 
        }
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) { margin-top: -135px; }
        #list-Pool .card-item, #list-Leader .card-item, #list-Base .card-item { margin-top: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.6); }
        
        .card-item:hover { 
            transform: scale(1.2); 
            z-index: 1000 !important; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); 
            border: 1px solid var(--accent); 
        }
        .card-item img { width: 100%; height: auto; display: block; border-radius: 6px; pointer-events: none; }

        .card-actions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; border-radius: 6px; }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 24px; color: #fff; font-weight: bold; pointer-events: none; background: rgba(0,0,0,0.6); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; }
        .stack-badge { position: absolute; top: 5px; right: 5px; background: var(--accent); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: 900; border: 2px solid #000; z-index: 5; box-shadow: 2px 2px 5px #000; }

        /* --- OVERLAYS --- */
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; }
        #preview-tooltip { position: fixed; display: none; z-index: 5000; pointer-events: none; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; }
        #preview-tooltip img { width: 320px; display: block; }
        #preview-tooltip.big-preview img { width: auto; height: 60vh; max-width: none; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
        #modal img { max-width:90vw; max-height:70vh; border-radius: 10px; display: block; box-shadow: 0 0 50px #000; border: 2px solid #333; }
        .big-flip-btn { background: var(--accent); color: #000; font-family: 'Orbitron'; font-size: 24px; font-weight: 900; padding: 15px 40px; border: 3px solid #000; border-radius: 8px; cursor: pointer; box-shadow: 0 0 20px var(--accent); margin-top: 20px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h1 style="color:var(--accent); font-family:'Orbitron'">STARTER SYSTEM</h1>
        <p id="loading-text" style="font-family:'Rajdhani'; font-size:18px; color:#ccc;">Leder efter swu_komplet_database.csv...</p>
    </div>

    <header>
        <div class="controls">
            <h1>SWU Drafter</h1>
            <select id="setSelect">
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="SEC">Secrets of Power (SEC)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
            </select>
            
            <label style="color:#aaa; font-size:12px; margin-left:5px;">Pakker:</label>
            <input type="number" id="packCount" value="6" min="1" max="24">
            <button class="btn" id="btn-open" onclick="openPacks()">ÅBN</button>

            <input type="text" id="searchInput" placeholder="Søg (Navn/Keyword)..." onkeyup="renderBoard()">

            <button class="btn" id="btn-toggle-lb" onclick="toggleLeadersBases()">Skjul L/B</button>
            <button class="btn" id="btn-sort" onclick="toggleSort()">Sorter: Cost</button>
            <button class="btn btn-pew" onclick="playAudio('snd-pew')">PEW PEW!</button>
            <button class="btn" style="background:#522;" onclick="resetDatabase()">Reset DB</button>
        </div>
        <div id="stats">
            <span class="stat">Pool: <span id="s-total">0</span></span>
        </div>
    </header>

    <div id="main-area">
        <div id="board"></div>
        <div id="sidebar">
            <div class="sb-header">Dit Deck (<span id="deck-count">0</span>)</div>
            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <button class="btn" style="width:100%" onclick="copyJSON()">Kopiér JSON</button>
                <button class="btn" style="width:100%; margin-top:5px; background:#4a1a1a; border-color:#6a2a2a;" onclick="clearDeck()">Slet Deck</button>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-card-container" onclick="flipLeader(event)">
            <img id="modal-img">
        </div>
        <button id="modal-flip-btn" class="big-flip-btn" onclick="flipLeader(event)">VEND LEADER ↻</button>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">Kopieret!</div>
    
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-pew" src="https://www.myinstants.com/media/sounds/pew_pew.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>

<script>
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism", "Neutral"];
const RARITY_COLS = ["Common", "Uncommon", "Rare", "Legendary", "Special"];

let myDeck = {}, currentView = [], areSpecialColsVisible = true, currentSortMode = 'cost';
let LOCAL_DATABASE = {};

window.onload = function() {
    fetch('swu_komplet_database.csv')
        .then(r => { if(!r.ok) throw new Error("404"); return r.text(); })
        .then(d => parseCSVandInstall(d))
        .catch(e => {
            const s = localStorage.getItem('SWU_DB');
            if (s) { LOCAL_DATABASE = JSON.parse(s); document.getElementById('loading-overlay').style.display = 'none'; initBoard(); } 
            else document.getElementById('loading-text').innerHTML = "Filen 'swu_komplet_database.csv' mangler.<br><input type='file' onchange='handleFileSelect(this.files)'>";
        });
};

function handleFileSelect(files) {
    if(!files[0]) return;
    const r = new FileReader();
    r.onload = e => parseCSVandInstall(e.target.result);
    r.readAsText(files[0]);
}

function parseCSVandInstall(csvText) {
    const lines = csvText.split(/\r\n|\n/);
    if(lines.length < 2) return;
    
    const h = lines[0].split(',');
    const m = {}; h.forEach((v,i)=>m[v.trim()]=i);
    const setMap = {'TWL': 'TWI', 'SOR': 'SOR', 'SHD': 'SHD', 'JTL': 'JTL', 'LOF': 'LOF', 'SEC': 'SEC'};
    const mainAspects = ["Aggression", "Command", "Cunning", "Vigilance"];
    const db = {};

    for(let i=1; i<lines.length; i++) {
        const row = parseCSVLine(lines[i]); 
        if(!row || row.length < h.length) continue;
        
        const rawSet = row[m['Source_Sheet']];
        if(!setMap[rawSet]) continue;
        const setCode = setMap[rawSet];

        const id = row[m['Card ID']].split('.')[0].padStart(3, '0');
        const name = row[m['Card Name']];
        const typeRaw = row[m['Type(s)']] || "Unit";
        const cost = parseInt(row[m['Cost']]) || 0;
        
        const keywords = row[m['Keyword(s)']] || "";
        const traits = row[m['Trait(s)']] || "";
        
        // --- RARITY FIX ---
        // Vi trimmer og tager første bogstav for at være sikre
        let rarVal = row[m['Rarity']] ? row[m['Rarity']].trim().toUpperCase() : "C";
        if(rarVal.length > 1) rarVal = rarVal.charAt(0); // Tager kun C, U, R, L, S
        
        let rarity = "Common";
        if(rarVal === 'C') rarity = "Common";
        else if(rarVal === 'U') rarity = "Uncommon";
        else if(rarVal === 'R') rarity = "Rare";
        else if(rarVal === 'L') rarity = "Legendary";
        else if(rarVal === 'S') rarity = "Special";

        // --- NEUTRAL FIX ---
        // Hvis den ikke har en af hovedfarverne, og heller ikke er Villainy/Heroism, så er den Neutral
        const a1 = row[m['Aspect(s)']] || "";
        const a2 = row[m['Unnamed: 12']] || ""; 
        
        let asp = "Neutral"; 
        
        // Prioritet: Color > Align > Neutral
        if(mainAspects.includes(a1) || mainAspects.includes(a2)) {
            if(mainAspects.includes(a1)) asp = a1; else asp = a2;
        } 
        else if(a1 === "Villainy" || a1 === "Heroism" || a2 === "Villainy" || a2 === "Heroism") {
            if(a1 === "Villainy" || a1 === "Heroism") asp = a1; else asp = a2;
        }
        // Ellers forbliver den "Neutral"
        
        const img = `https://swudb.com/images/cards/${setCode}/${id}.png`;
        const cardObj = { id, set: setCode, name, cost: cost.toString(), aspect: asp, rarity: rarity, img, keywords, traits };

        if(!db[setCode]) db[setCode] = {leaders:[], bases:[], deck:[]};
        if(typeRaw.includes('Leader')) { cardObj.type='Leader'; cardObj.back=`https://swudb.com/images/cards/${setCode}/${id}-back.png`; db[setCode].leaders.push(cardObj); }
        else if(typeRaw.includes('Base')) { cardObj.type='Base'; db[setCode].bases.push(cardObj); }
        else if(typeRaw.includes('Unit')||typeRaw.includes('Event')||typeRaw.includes('Upgrade')) { cardObj.type='Unit'; db[setCode].deck.push(cardObj); }
    }

    LOCAL_DATABASE = db;
    try { localStorage.setItem('SWU_DB', JSON.stringify(db)); } catch(e){}
    document.getElementById('loading-overlay').style.display = 'none';
    initBoard();
}

function parseCSVLine(text) {
    const re = /(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
    const a = [];
    text.replace(re, (m0,m1,m2,m3) => {
        if(m1!==undefined) a.push(m1.replace(/\\'/g,"'"));
        else if(m2!==undefined) a.push(m2.replace(/\\"/g,'"'));
        else if(m3!==undefined) a.push(m3);
        return '';
    });
    return a;
}

function getCostColumn(c) { const v=parseInt(c); if(isNaN(v)||v<=1)return "1"; if(v>=8)return "8"; return v.toString(); }
function getSetData(sc) { return (LOCAL_DATABASE[sc]&&LOCAL_DATABASE[sc].deck.length) ? LOCAL_DATABASE[sc] : {leaders:[],bases:[],deck:[]}; }

function resetDatabase() {
    if(confirm("Vil du slette databasen og genindlæse?")) {
        localStorage.removeItem('SWU_DB');
        location.reload();
    }
}

function openPacks() {
    const btn = document.getElementById('btn-open');
    const setCode = document.getElementById('setSelect').value;
    const count = parseInt(document.getElementById('packCount').value)||6;
    btn.disabled = true;
    playAudio('snd-cantina');
    const d = getSetData(setCode);
    if(!d.deck.length) { btn.disabled=false; alert("Vent venligst."); return; }
    
    currentView = [];
    for(let i=0; i<count; i++) {
        if(d.leaders.length) currentView.push({...d.leaders[Math.floor(Math.random()*d.leaders.length)], uid:Date.now()+i+'l', column:'Leader'});
        if(d.bases.length) currentView.push({...d.bases[Math.floor(Math.random()*d.bases.length)], uid:Date.now()+i+'b', column:'Base'});
        for(let k=0; k<14; k++) {
            if(d.deck.length) {
                const c = d.deck[Math.floor(Math.random()*d.deck.length)];
                let col;
                if (currentSortMode === 'cost') col = getCostColumn(c.cost);
                else if (currentSortMode === 'rarity') col = c.rarity;
                else col = c.aspect; 
                
                currentView.push({...c, uid:Date.now()+i+k+'d', column:col});
            }
        }
    }
    renderBoard(); btn.disabled=false;
}

function initBoard() {
    const b = document.getElementById('board'); b.innerHTML = '';
    let cols;
    
    if(currentSortMode === 'cost') cols = ["Leader", "Base", "Pool", ...COST_COLS];
    else if(currentSortMode === 'rarity') cols = ["Leader", "Base", "Pool", ...RARITY_COLS];
    else cols = ["Leader", "Base", "Pool", ...ASPECT_COLS];
    
    cols.forEach(cn => {
        const c = document.createElement('div'); c.id = `col-${cn}`;
        c.className = 'column' + (cn==='Leader'||cn==='Base'?' col-special':cn==='Pool'?' col-pool':'');
        c.ondragover = e => { e.preventDefault(); c.classList.add('drag-over'); };
        c.ondragleave = e => c.classList.remove('drag-over');
        c.ondrop = e => handleDropOnBoard(e, cn);
        
        let hc = "ch-cost";
        if(cn==="Leader") hc="ch-Leader"; 
        else if(cn==="Base") hc="ch-Base"; 
        else if(ASPECT_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(RARITY_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(cn==="Neutral") hc="ch-Neutral";
        
        c.innerHTML = `<div class="col-header ${hc}">${cn}</div><div class="col-content" id="list-${cn}"></div>`;
        b.appendChild(c);
    });
    const s = document.getElementById('sidebar');
    s.ondragover = e => { e.preventDefault(); s.classList.add('drag-over-deck'); };
    s.ondragleave = e => s.classList.remove('drag-over-deck');
    s.ondrop = e => handleDropOnDeck(e);
    toggleLeadersBases(true);
}

function renderBoard() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const allCols = ["Leader", "Base", "Pool", ...COST_COLS, ...ASPECT_COLS, ...RARITY_COLS];
    allCols.forEach(cn => { const el=document.getElementById(`list-${cn}`); if(el) el.innerHTML=''; });

    const map = {};
    let displayCount = 0;

    currentView.forEach(c => {
        if (searchTerm) {
            const textToSearch = (c.name + " " + (c.keywords||"") + " " + (c.traits||"")).toLowerCase();
            if (!textToSearch.includes(searchTerm)) return;
        }
        displayCount++;
        
        if(c.type!=='Leader' && c.type!=='Base' && c.column!=='Pool') {
             if (currentSortMode === 'cost') c.column = getCostColumn(c.cost);
             else if (currentSortMode === 'rarity') c.column = c.rarity;
             else c.column = c.aspect;
        }
        const k = `${c.id}_${c.column}`;
        if(map[k]) map[k].count++; else map[k] = {...c, count:1};
    });

    document.getElementById('s-total').innerText = displayCount + (searchTerm ? " (Filtreret)" : "");
    
    Object.values(map).forEach(c => {
        const t = document.getElementById(`list-${c.column}`) || document.getElementById('list-Pool');
        if(!t) return;
        const el = document.createElement('div'); el.className = `card-item`; el.draggable = true;
        el.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'board'}));
        el.onclick = e => { if(e.target.tagName!=='DIV') openModal(c); };
        el.onmouseenter = e => showPreview(e,c.img,c.type); 
        el.onmouseleave = hidePreview; el.onmousemove = e => movePreview(e);
        el.innerHTML = (c.count>1?`<div class="stack-badge">${c.count}</div>`:'') + 
            `<img src="${c.img}" draggable="false"><div class="card-actions" onclick="addToDeck('${c.id}','${c.set}')"><div class="add-icon">+</div></div>`;
        t.appendChild(el);
    });
}

function toggleSort() {
    const btn = document.getElementById('btn-sort');
    if(currentSortMode === 'cost') currentSortMode = 'aspect';
    else if(currentSortMode === 'aspect') currentSortMode = 'rarity';
    else currentSortMode = 'cost';
    
    const label = currentSortMode.charAt(0).toUpperCase() + currentSortMode.slice(1);
    btn.innerText = `Sorter: ${label}`;
    initBoard(); renderBoard();
}
function toggleLeadersBases(m) {
    if(!m) areSpecialColsVisible = !areSpecialColsVisible;
    document.getElementById('col-Leader').style.display = areSpecialColsVisible ? 'flex' : 'none';
    document.getElementById('col-Base').style.display = areSpecialColsVisible ? 'flex' : 'none';
    document.getElementById('btn-toggle-lb').innerText = areSpecialColsVisible ? "Skjul L/B" : "Vis L/B";
}

function addToDeck(id, set) {
    const idx = currentView.findIndex(c => c.id===id && c.set===set);
    if(idx===-1) return;
    const c = currentView[idx]; currentView.splice(idx, 1); 
    const k = `${c.set}_${c.id}`;
    if(myDeck[k]) myDeck[k].count++; else myDeck[k] = {...c, count:1}; 
    renderBoard(); updateSidebar();
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;
    const c = myDeck[key]; c.count--;
    if(c.count<=0) delete myDeck[key];
    currentView.push({...c, count:undefined, uid:Date.now(), column:'Pool'});
    renderBoard(); updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    Object.values(myDeck).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
        sum += c.count;
        const li = document.createElement('li');
        li.draggable = true;
        li.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'deck'}));
        li.style.borderLeftColor = (c.type==='Leader'?'#fff':c.type==='Base'?'#aaa':`var(--c-${c.aspect})`);
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent);font-weight:bold;">${c.count}</span>`;
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        li.onmouseenter = e => showPreview(e,c.img,c.type);
        li.onmouseleave = hidePreview; li.onmousemove = e => movePreview(e);
        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
}
function clearDeck() { Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) currentView.push({...c, count:undefined, column:'Pool'}); }); myDeck={}; renderBoard(); updateSidebar(); }
function playAudio(id) { const s=document.getElementById(id); if(s){s.volume=0.4; s.currentTime=0; s.play().catch(e=>{});} }

function handleDropOnDeck(e) { 
    e.preventDefault(); document.getElementById('sidebar').classList.remove('drag-over-deck');
    try { const d=JSON.parse(e.dataTransfer.getData("text/plain")); if(d.source==='board') addToDeck(d.id,d.set); } catch(e){} 
}
function handleDropOnBoard(e, cn) {
    e.preventDefault(); document.getElementById('col-'+cn).classList.remove('drag-over');
    try {
        const d = JSON.parse(e.dataTransfer.getData("text/plain"));
        if(d.source==='deck') {
            const k=`${d.set}_${d.id}`;
            if(myDeck[k]) {
                myDeck[k].count--; if(myDeck[k].count<=0) delete myDeck[k];
                const info = LOCAL_DATABASE[d.set].deck.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].leaders.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].bases.find(x=>x.id==d.id);
                if(info) currentView.push({...info, uid:Date.now(), column:cn});
                renderBoard(); updateSidebar();
            }
        } else if(d.source==='board') {
            const i = currentView.findIndex(c => c.id===d.id && c.set===d.set);
            if(i!==-1) { currentView[i].column=cn; renderBoard(); }
        }
    } catch(e){}
}

function copyJSON() { 
    const d={metadata:{name:"Draft Deck",author:"User"},leader:{id:"",count:0},base:{id:"",count:0},deck:[],sideboard:[]};
    Object.values(myDeck).forEach(c=>{ 
        const pid = `${c.set.toLowerCase()}_${c.id}`;
        const entry = {id: pid, count: c.count}; 
        if(c.type==='Leader') { d.leader = entry; } 
        else if(c.type==='Base') { d.base = entry; } 
        else d.deck.push(entry); 
    });
    const el=document.createElement('textarea'); el.value=JSON.stringify(d,null,2); 
    document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); 
    playAudio('snd-copy'); 
    document.getElementById('toast').className = 'show'; setTimeout(()=>document.getElementById('toast').className='', 2000);
}

const tip = document.getElementById('preview-tooltip');
let isP = false, isT = false;
function showPreview(e,src,t) { isP=true; tip.innerHTML=`<img src="${src}">`; tip.className=t==='Leader'||t==='Base'?'big-preview':''; tip.style.display='block'; reqUpd(e); }
function movePreview(e) { if(isP) reqUpd(e); }
function hidePreview() { isP=false; tip.style.display='none'; }
function reqUpd(e) { if(!isT) { requestAnimationFrame(()=>{ updPos(e); isT=false; }); isT=true; } }
function updPos(e) {
    const w=window.innerWidth, h=window.innerHeight;
    let x=e.clientX+20, y=e.clientY+10;
    const tipW=tip.className.includes('big')?600:320;
    if(x+tipW>w) x=e.clientX-tipW-20;
    if(y+(tip.offsetHeight||400)>h) y=h-(tip.offsetHeight||400)-20;
    tip.style.top=y+'px'; tip.style.left=x+'px';
}

const modal=document.getElementById('modal'), mImg=document.getElementById('modal-img'), mBtn=document.getElementById('modal-flip-btn');
let zC=null;
function openModal(c) { zC=c; modal.style.display='flex'; mImg.src=c.img; mBtn.style.display=c.type==='Leader'?'block':'none'; }
function flipLeader(e) { if(e)e.stopPropagation(); if(!zC||zC.type!=='Leader')return; const b=mImg.src.includes("-back"); mImg.src=b?zC.img:zC.back; }
function closeModal() { modal.style.display='none'; }
</script>
</body>
</html>
