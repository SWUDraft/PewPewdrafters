<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: GitHub Drafter (Save & Layout Fix)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #FFE81F; 
            --accent-glow: rgba(255, 232, 31, 0.4);
            --text-main: #e0e0e0;
            
            --c-Aggression: #bd1e2d; --c-Command: #377d22; --c-Cunning: #f2c035;    
            --c-Vigilance: #006eb6; --c-Villainy: #222222; --c-Heroism: #eeeeee; --c-Neutral: #555555;

            --c-Common: #aaaaaa; --c-Uncommon: #55aaff; --c-Rare: #ffcc00;
            --c-Legendary: #aa55ff; --c-Special: #ff4444;

            --c-leader: #fff; --c-base: #aaa; --c-unit: #444; --c-pool: #402020; 
            --success-green: #0a0;
        }

        body { background: var(--bg); color: var(--text-main); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER (Z-INDEX FIX) --- */
        header { 
            padding: 10px 20px; 
            background: #080808; 
            border-bottom: 2px solid #333; 
            display: flex; align-items: center; justify-content: space-between; 
            height: 70px; 
            z-index: 5000; /* FIX: Meget høj Z-index så intet går over */
            box-shadow: 0 5px 20px rgba(0,0,0,0.9);
            position: relative;
        }
        h1 { margin: 0; font-family: 'Orbitron'; color: var(--accent); font-size: 22px; letter-spacing: 2px; text-shadow: 0 0 10px var(--accent-glow); margin-right: 20px; }
        
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        
        select, input { 
            background: #1a1a1a; color: var(--accent); border: 1px solid #444; padding: 8px 12px; 
            font-family: 'Orbitron'; font-size: 14px; border-radius: 4px; outline: none; transition: 0.3s; 
        }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        input[type="number"] { width: 60px; text-align: center; font-weight: bold; }
        
        button.btn { 
            background: linear-gradient(180deg, #3a3a3a 0%, #222 100%); color: #fff; border: 1px solid #555; 
            padding: 8px 20px; font-family: 'Orbitron'; cursor: pointer; transition: all 0.2s ease-in-out; 
            border-radius: 4px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        button.btn:hover { border-color: var(--accent); color: var(--accent); background: linear-gradient(180deg, #444 0%, #111 100%); box-shadow: 0 0 15px var(--accent-glow); transform: translateY(-2px); }
        button.btn:active { transform: translateY(1px); box-shadow: none; }
        button.btn:disabled { color: #555; border-color: #333; cursor: wait; opacity: 0.6; transform: none; box-shadow: none; }
        
        button.btn-action { border-color: var(--accent); color: var(--accent); }
        button.btn-reset { background: #311; border-color: #522; color: #a88; }
        button.btn-reset:hover { background: #511; border-color: #f55; color: #fff; box-shadow: 0 0 10px rgba(255,0,0,0.4); }

        /* Save/Load Buttons */
        .btn-save { background: #131; border-color: #252; color: #ada; width: 48%; }
        .btn-load { background: #113; border-color: #225; color: #aad; width: 48%; }

        .stat { font-family: 'Orbitron'; font-size: 14px; color: #aaa; margin-right: 20px; letter-spacing: 1px; }
        .stat span { color: var(--accent); font-size: 18px; }
        #db-status { font-size: 11px; color: #777; font-family: monospace; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; background: #111; }

        /* --- MAIN AREA --- */
        #main-area { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }
        #board { flex: 1; display: flex; gap: 12px; padding: 20px; overflow-x: auto; background: url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat; align-items: flex-start; }
        #board::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: -1; pointer-events: none; }

        /* --- COLUMNS --- */
        .column { 
            background: rgba(25, 25, 25, 0.95); border: 1px solid #444; border-radius: 6px; 
            display: flex; flex-direction: column; transition: all 0.3s ease; flex-shrink: 0; 
            height: 100%; min-width: 160px; width: 160px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            overflow: hidden; position: relative;
        }
        .column.drag-over { background: rgba(60, 60, 60, 0.95); box-shadow: 0 0 25px var(--accent); border-color: var(--accent); }
        .col-special { width: 180px; min-width: 180px; border: 1px solid #666; }
        .col-pool { width: 180px; min-width: 180px; border: 1px solid #644; background: rgba(35, 20, 20, 0.95); }

        .column.collapsed { min-width: 40px; width: 40px; background: #111; border-color: #333; }
        .column.collapsed .col-content { display: none; }
        .column.collapsed .col-header { 
            height: 100%; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); 
            display: flex; align-items: center; justify-content: center; padding: 0;
        }
        .column.collapsed .header-title { margin-bottom: 10px; font-size: 14px; letter-spacing: 2px; }
        .column.collapsed .col-toggle { transform: rotate(90deg); margin-bottom: 10px; }

        .col-header { 
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            font-family: 'Orbitron'; font-weight: 900; font-size: 18px; 
            border-bottom: 4px solid transparent; text-transform: uppercase; 
            background: rgba(0,0,0,0.8); z-index: 20; /* Higher Z than content */
            position: relative;
            letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        
        .col-toggle {
            background: transparent; border: 1px solid #555; color: #777;
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-family: monospace; font-size: 16px; line-height: 1; transition: 0.2s;
        }
        .col-toggle:hover { border-color: var(--accent); color: var(--accent); background: #222; }

        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); }
        .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); }
        .ch-Pool { border-bottom-color: var(--c-pool); color: #faa; }
        .ch-Aggression { border-bottom-color: var(--c-Aggression); color: var(--c-Aggression); }
        .ch-Command { border-bottom-color: var(--c-Command); color: var(--c-Command); }
        .ch-Cunning { border-bottom-color: var(--c-Cunning); color: var(--c-Cunning); }
        .ch-Vigilance { border-bottom-color: var(--c-Vigilance); color: var(--c-Vigilance); }
        .ch-Villainy { border-bottom-color: var(--c-Villainy); color: #999; }
        .ch-Heroism { border-bottom-color: var(--c-Heroism); color: #fff; }
        .ch-Neutral { border-bottom-color: var(--c-Neutral); color: #bbb; }
        .ch-Common { border-bottom-color: var(--c-Common); color: var(--c-Common); }
        .ch-Uncommon { border-bottom-color: var(--c-Uncommon); color: var(--c-Uncommon); }
        .ch-Rare { border-bottom-color: var(--c-Rare); color: var(--c-Rare); }
        .ch-Legendary { border-bottom-color: var(--c-Legendary); color: var(--c-Legendary); }
        .ch-Special { border-bottom-color: var(--c-Special); color: var(--c-Special); }
        .ch-cost { border-bottom-color: #666; color: #fff; font-size: 24px; }

        .col-content { 
            flex: 1; overflow-y: auto; overflow-x: visible; 
            padding: 15px 8px 50px 8px; 
            display: flex; flex-direction: column; align-items: center; 
            scrollbar-width: thin; scrollbar-color: #444 #111; 
            position: relative; z-index: 10;
        }
        #list-Pool { display: grid; grid-template-columns: 1fr; gap: 8px; align-content: start; align-items: center; }

        /* --- SIDEBAR --- */
        #sidebar { width: 300px; background: #111; border-left: 2px solid #333; display: flex; flex-direction: column; z-index: 4000; transition: all 0.2s; position: relative; flex-shrink: 0; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
        #sidebar.drag-over-deck { background: #1a1a1a; box-shadow: inset 0 0 30px var(--accent-glow); border-left-color: var(--accent); }
        .sb-header { padding: 20px; background: #151515; border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); font-size: 16px; letter-spacing: 1px; text-align: center; }
        #deck-list { flex: 1; overflow-y: auto; padding: 15px; list-style: none; margin: 0; }
        #deck-list li { 
            background: #222; padding: 8px 12px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; 
            border-left: 4px solid #555; font-size: 14px; border-radius: 4px; cursor: pointer; transition: all 0.1s; 
        }
        #deck-list li:hover { background: #333; color: #fff; transform: translateX(5px); border-left-color: var(--accent) !important; }
        .sb-footer { padding: 15px; border-top: 1px solid #333; background: #151515; }
        .save-load-container { display: flex; justify-content: space-between; margin-bottom: 10px; }

        /* --- CARD ITEM --- */
        .card-item { 
            position: relative; background: #000; border-radius: 8px; cursor: grab; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.8); 
            transition: transform 0.1s ease-out; 
            display: flex; flex-direction: column; width: 100%; z-index: 1; 
            will-change: transform; border: 1px solid #333;
        }
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) { margin-top: -140px; }
        #list-Pool .card-item, #list-Leader .card-item, #list-Base .card-item { margin-top: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.9); }
        
        .card-item:hover { 
            transform: scale(1.15); 
            z-index: 1000 !important; /* Below header (5000), above other cards */
            box-shadow: 0 0 25px rgba(0,0,0,0.9); 
            border-color: var(--accent); 
        }
        .card-item img { width: 100%; height: auto; display: block; border-radius: 8px; pointer-events: none; }
        .card-actions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; border-radius: 8px; backdrop-filter: blur(2px); }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 30px; color: var(--accent); font-weight: 900; pointer-events: none; background: rgba(0,0,0,0.8); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .stack-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #000; width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: 900; border: 2px solid #000; z-index: 10; box-shadow: 2px 2px 5px #000; }

        /* --- OVERLAYS --- */
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; }
        #upload-zone { border: 2px dashed #555; padding: 40px; border-radius: 10px; background: #222; margin-top: 20px; }
        
        #preview-tooltip { position: fixed; display: none; z-index: 6000; pointer-events: none; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; }
        #preview-tooltip img { width: 340px; display: block; }
        #preview-tooltip.big-preview img { width: auto; height: 65vh; max-width: none; }
        
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:7000; justify-content:center; align-items:center; flex-direction: column; }
        #modal img { max-width:90vw; max-height:70vh; border-radius: 12px; display: block; box-shadow: 0 0 50px #000; border: 2px solid #333; }
        .big-flip-btn { background: var(--accent); color: #000; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; padding: 15px 40px; border: 3px solid #000; border-radius: 8px; cursor: pointer; box-shadow: 0 0 20px var(--accent); margin-top: 20px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #222; color: var(--accent); text-align: center; border-radius: 4px; padding: 15px; position: fixed; z-index: 8000; left: 50%; bottom: 40px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent); box-shadow: 0 0 20px rgba(0,0,0,0.8); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h1 style="color:var(--accent); font-family:'Orbitron'; font-size: 30px;">SYSTEM INITIALIZING</h1>
        <p id="loading-text" style="font-family:'Rajdhani'; font-size:20px; color:#ccc;">Connecting to Database...</p>
        <div id="upload-zone" style="display:none;">
            <p style="color:#e55; font-weight:bold; font-family:'Orbitron'">DATABASE NOT FOUND</p>
            <p style="margin-bottom:15px;">Please upload 'swu_komplet_database.csv' manually:</p>
            <input type="file" onchange="handleFileSelect(this.files)" accept=".csv" style="background:#333; color:#fff;">
        </div>
    </div>

    <header>
        <div class="controls">
            <h1>SWU DRAFTER</h1>
            <select id="setSelect">
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="SEC">Secrets of Power (SEC)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
            </select>
            <label style="color:#777; font-size:11px; margin-left:5px; text-transform:uppercase; font-weight:bold;">Packs:</label>
            <input type="number" id="packCount" value="6" min="1" max="24">
            <button class="btn btn-action" id="btn-open" onclick="openPacks()">OPEN PACKS</button>
            <button class="btn" id="btn-sort" onclick="toggleSort()">SORT: COST</button>
            <button class="btn btn-reset" onclick="resetDatabase()">RESET DB</button>
            <span id="db-status">DB: 0</span>
        </div>
        <div id="stats">
            <span class="stat">POOL: <span id="s-total">0</span></span>
        </div>
    </header>

    <div id="main-area">
        <div id="board"></div>
        <div id="sidebar">
            <div class="sb-header">YOUR DECK (<span id="deck-count">0</span>)</div>
            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <div class="save-load-container">
                    <button class="btn btn-save" onclick="saveDeck()">SAVE DECK</button>
                    <button class="btn btn-load" onclick="loadDeck()">LOAD DECK</button>
                </div>
                <button class="btn" style="width:100%" onclick="copyJSON()">COPY JSON</button>
                <button class="btn" style="width:100%; margin-top:8px; background:#522; border-color:#844; color:#faa;" onclick="clearDeck()">CLEAR DECK</button>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-card-container" onclick="flipLeader(event)">
            <img id="modal-img">
        </div>
        <button id="modal-flip-btn" class="big-flip-btn" onclick="flipLeader(event)">FLIP LEADER ↻</button>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">COPIED TO CLIPBOARD!</div>
    
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>

<script>
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism", "Neutral"];
const RARITY_COLS = ["Common", "Uncommon", "Rare", "Legendary", "Special"];

let myDeck = {}, currentView = [], currentSortMode = 'cost';
let LOCAL_DATABASE = {};

window.onload = function() {
    fetch('swu_komplet_database.csv')
        .then(r => { if(!r.ok) throw new Error("404"); return r.text(); })
        .then(d => parseCSVandInstall(d))
        .catch(e => {
            const s = localStorage.getItem('SWU_DB');
            if (s) { 
                LOCAL_DATABASE = JSON.parse(s); 
                updateDBStatus();
                document.getElementById('loading-overlay').style.display = 'none'; 
                initBoard(); 
            } 
            else {
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('upload-zone').style.display = 'block';
            }
        });
};

function handleFileSelect(files) {
    if(!files[0]) return;
    const r = new FileReader();
    r.onload = e => parseCSVandInstall(e.target.result);
    r.readAsText(files[0]);
}

function parseCSVandInstall(csvText) {
    const rows = [];
    let currentRow = [];
    let currentVal = '';
    let insideQuote = false;
    let firstLineEnd = csvText.indexOf('\n');
    if(firstLineEnd === -1) firstLineEnd = csvText.length;
    const firstLine = csvText.substring(0, firstLineEnd);
    const delim = firstLine.includes(';') ? ';' : ',';

    for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i+1];
        if (char === '"') {
            if (insideQuote && nextChar === '"') { currentVal += '"'; i++; } 
            else { insideQuote = !insideQuote; }
        } else if (char === delim && !insideQuote) {
            currentRow.push(currentVal.trim()); currentVal = '';
        } else if ((char === '\n' || char === '\r') && !insideQuote) {
            if (char === '\r' && nextChar === '\n') i++;
            currentRow.push(currentVal.trim());
            if (currentRow.length > 1) rows.push(currentRow);
            currentRow = []; currentVal = '';
        } else { currentVal += char; }
    }
    if (currentRow.length > 1) rows.push(currentRow);

    if(rows.length < 2) { alert("File seems empty or invalid format."); return; }
    
    const h = rows[0];
    const m = {}; 
    h.forEach((v,i) => m[v.replace(/^"|"$/g, '').trim()] = i); 
    
    let idIdx = -1, costIdx = -1, setIdx = -1, typeIdx = -1;
    Object.keys(m).forEach(k => {
        if(k.includes('Card ID')) idIdx = m[k];
        if(k === 'Cost') costIdx = m[k];
        if(k.includes('Source')) setIdx = m[k];
        if(k.includes('Type')) typeIdx = m[k];
    });

    if(idIdx === -1 || costIdx === -1) {
        alert("Error: Could not identify 'Card ID' or 'Cost' columns. Please check CSV headers.");
        return;
    }

    const setMap = {'TWL': 'TWI', 'SOR': 'SOR', 'SHD': 'SHD', 'JTL': 'JTL', 'LOF': 'LOF', 'SEC': 'SEC'};
    const mainAspects = ["Aggression", "Command", "Cunning", "Vigilance"];
    const db = {};
    let count = 0;

    for(let i=1; i<rows.length; i++) {
        const row = rows[i];
        if(row.length < h.length) continue;
        
        const rawSet = row[setIdx];
        if(!setMap[rawSet]) continue;
        const setCode = setMap[rawSet];

        const id = row[idIdx].split('.')[0].padStart(3, '0');
        const name = row[m['Card Name']];
        const typeRaw = row[typeIdx] || "Unit";
        const cost = parseInt(row[costIdx]) || 0;
        
        let rarVal = row[m['Rarity']] ? row[m['Rarity']].trim().toUpperCase() : "C";
        if(rarVal.length > 0) rarVal = rarVal.charAt(0);
        let rarity = "Common";
        if(rarVal === 'U') rarity = "Uncommon";
        else if(rarVal === 'R') rarity = "Rare";
        else if(rarVal === 'L') rarity = "Legendary";
        else if(rarVal === 'S') rarity = "Special";

        const a1 = row[m['Aspect(s)']] || "";
        const a2 = row[m['Unnamed: 12']] || ""; 
        let asp = "Neutral"; 
        const isMain = (a) => mainAspects.includes(a);
        const isAlign = (a) => a === "Villainy" || a === "Heroism";

        if (isMain(a1)) asp = a1;
        else if (isMain(a2)) asp = a2;
        else if (isAlign(a1)) asp = a1;
        else if (isAlign(a2)) asp = a2;

        const img = `https://swudb.com/images/cards/${setCode}/${id}.png`;
        const cardObj = { id, set: setCode, name, cost: cost.toString(), aspect: asp, rarity: rarity, img };

        if(!db[setCode]) db[setCode] = {leaders:[], bases:[], deck:[]};
        
        if(typeRaw.includes('Leader')) { cardObj.type='Leader'; cardObj.back=`https://swudb.com/images/cards/${setCode}/${id}-back.png`; db[setCode].leaders.push(cardObj); }
        else if(typeRaw.includes('Base')) { cardObj.type='Base'; db[setCode].bases.push(cardObj); }
        else if(typeRaw.includes('Unit')||typeRaw.includes('Event')||typeRaw.includes('Upgrade')) { cardObj.type='Unit'; db[setCode].deck.push(cardObj); }
        count++;
    }

    LOCAL_DATABASE = db;
    updateDBStatus();
    try { localStorage.setItem('SWU_DB', JSON.stringify(db)); } catch(e){}
    document.getElementById('loading-overlay').style.display = 'none';
    initBoard();
}

function updateDBStatus() {
    let c = 0;
    Object.values(LOCAL_DATABASE).forEach(s => { c += s.deck.length + s.leaders.length + s.bases.length; });
    document.getElementById('db-status').innerText = `DB: ${c} CARDS`;
    document.getElementById('db-status').style.color = c > 0 ? '#0a0' : '#f55';
}

function getCostColumn(c) { const v=parseInt(c); if(isNaN(v)||v<=1)return "1"; if(v>=8)return "8"; return v.toString(); }
function getSetData(sc) { return (LOCAL_DATABASE[sc]&&LOCAL_DATABASE[sc].deck.length) ? LOCAL_DATABASE[sc] : {leaders:[],bases:[],deck:[]}; }

function resetDatabase() {
    if(confirm("Reset Database and reload?")) {
        localStorage.removeItem('SWU_DB');
        location.reload();
    }
}

function openPacks() {
    const btn = document.getElementById('btn-open');
    const setCode = document.getElementById('setSelect').value;
    const count = parseInt(document.getElementById('packCount').value)||6;
    btn.disabled = true;
    playAudio('snd-cantina');
    
    const d = getSetData(setCode);
    if(!d.deck.length) { 
        btn.disabled=false; 
        alert(`No cards found for ${setCode}. Database might be empty.`); 
        return; 
    }
    
    currentView = [];
    for(let i=0; i<count; i++) {
        if(d.leaders.length) currentView.push({...d.leaders[Math.floor(Math.random()*d.leaders.length)], uid:Date.now()+i+'l', column:'Leader'});
        if(d.bases.length) currentView.push({...d.bases[Math.floor(Math.random()*d.bases.length)], uid:Date.now()+i+'b', column:'Base'});
        for(let k=0; k<14; k++) {
            if(d.deck.length) {
                const c = d.deck[Math.floor(Math.random()*d.deck.length)];
                let col;
                if (currentSortMode === 'cost') col = getCostColumn(c.cost);
                else if (currentSortMode === 'rarity') col = c.rarity;
                else col = c.aspect; 
                
                currentView.push({...c, uid:Date.now()+i+k+'d', column:col});
            }
        }
    }
    renderBoard(); btn.disabled=false;
}

function toggleCol(id) {
    const el = document.getElementById(id);
    const btn = el.querySelector('.col-toggle');
    el.classList.toggle('collapsed');
    btn.innerText = el.classList.contains('collapsed') ? '+' : '-';
}

function initBoard() {
    const b = document.getElementById('board'); b.innerHTML = '';
    let cols;
    
    if(currentSortMode === 'cost') cols = ["Leader", "Base", "Pool", ...COST_COLS];
    else if(currentSortMode === 'rarity') cols = ["Leader", "Base", "Pool", ...RARITY_COLS];
    else cols = ["Leader", "Base", "Pool", ...ASPECT_COLS];
    
    cols.forEach(cn => {
        const c = document.createElement('div'); c.id = `col-${cn}`;
        c.className = 'column' + (cn==='Leader'||cn==='Base'?' col-special':cn==='Pool'?' col-pool':'');
        c.ondragover = e => { e.preventDefault(); c.classList.add('drag-over'); };
        c.ondragleave = e => c.classList.remove('drag-over');
        c.ondrop = e => handleDropOnBoard(e, cn);
        
        let hc = "ch-cost";
        if(cn==="Leader") hc="ch-Leader"; 
        else if(cn==="Base") hc="ch-Base"; 
        else if(ASPECT_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(RARITY_COLS.includes(cn)) hc=`ch-${cn}`;
        else if(cn==="Neutral") hc="ch-Neutral";
        
        c.innerHTML = `<div class="col-header ${hc}">
            <span class="header-title">${cn}</span>
            <button class="col-toggle" onclick="toggleCol('col-${cn}')">-</button>
        </div><div class="col-content" id="list-${cn}"></div>`;
        b.appendChild(c);
    });
    const s = document.getElementById('sidebar');
    s.ondragover = e => { e.preventDefault(); s.classList.add('drag-over-deck'); };
    s.ondragleave = e => s.classList.remove('drag-over-deck');
    s.ondrop = e => handleDropOnDeck(e);
}

function renderBoard() {
    const allCols = ["Leader", "Base", "Pool", ...COST_COLS, ...ASPECT_COLS, ...RARITY_COLS];
    allCols.forEach(cn => { const el=document.getElementById(`list-${cn}`); if(el) el.innerHTML=''; });

    const map = {};
    currentView.forEach(c => {
        if(c.type!=='Leader' && c.type!=='Base' && c.column!=='Pool') {
             if (currentSortMode === 'cost') c.column = getCostColumn(c.cost);
             else if (currentSortMode === 'rarity') c.column = c.rarity;
             else c.column = c.aspect;
        }
        const k = `${c.id}_${c.column}`;
        if(map[k]) map[k].count++; else map[k] = {...c, count:1};
    });

    document.getElementById('s-total').innerText = currentView.length;
    
    Object.values(map).forEach(c => {
        const t = document.getElementById(`list-${c.column}`) || document.getElementById('list-Pool');
        if(!t) return;
        const el = document.createElement('div'); el.className = `card-item`; el.draggable = true;
        el.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'board'}));
        el.onclick = e => { if(e.target.tagName!=='DIV') openModal(c); };
        el.onmouseenter = e => showPreview(e,c.img,c.type); 
        el.onmouseleave = hidePreview; el.onmousemove = e => movePreview(e);
        el.innerHTML = (c.count>1?`<div class="stack-badge">${c.count}</div>`:'') + 
            `<img src="${c.img}" draggable="false"><div class="card-actions" onclick="addToDeck('${c.id}','${c.set}')"><div class="add-icon">+</div></div>`;
        t.appendChild(el);
    });
}

function toggleSort() {
    const btn = document.getElementById('btn-sort');
    if(currentSortMode === 'cost') currentSortMode = 'aspect';
    else if(currentSortMode === 'aspect') currentSortMode = 'rarity';
    else currentSortMode = 'cost';
    
    btn.innerText = `SORT: ${currentSortMode.toUpperCase()}`;
    initBoard(); renderBoard();
}

function addToDeck(id, set) {
    const idx = currentView.findIndex(c => c.id===id && c.set===set);
    if(idx===-1) return;
    const c = currentView[idx]; currentView.splice(idx, 1); 
    const k = `${c.set}_${c.id}`;
    if(myDeck[k]) myDeck[k].count++; else myDeck[k] = {...c, count:1}; 
    renderBoard(); updateSidebar();
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;
    const c = myDeck[key]; c.count--;
    if(c.count<=0) delete myDeck[key];
    currentView.push({...c, count:undefined, uid:Date.now(), column:'Pool'});
    renderBoard(); updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    Object.values(myDeck).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
        sum += c.count;
        const li = document.createElement('li');
        li.draggable = true;
        li.ondragstart = e => e.dataTransfer.setData("text/plain", JSON.stringify({id:c.id, set:c.set, source:'deck'}));
        li.style.borderLeftColor = (c.type==='Leader'?'#fff':c.type==='Base'?'#aaa':`var(--c-${c.aspect})`);
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent);font-weight:bold;">${c.count}</span>`;
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        li.onmouseenter = e => showPreview(e,c.img,c.type);
        li.onmouseleave = hidePreview; li.onmousemove = e => movePreview(e);
        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
}
function clearDeck() { Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) currentView.push({...c, count:undefined, column:'Pool'}); }); myDeck={}; renderBoard(); updateSidebar(); }
function playAudio(id) { const s=document.getElementById(id); if(s){s.volume=0.4; s.currentTime=0; s.play().catch(e=>{});} }

function handleDropOnDeck(e) { 
    e.preventDefault(); document.getElementById('sidebar').classList.remove('drag-over-deck');
    try { const d=JSON.parse(e.dataTransfer.getData("text/plain")); if(d.source==='board') addToDeck(d.id,d.set); } catch(e){} 
}
function handleDropOnBoard(e, cn) {
    e.preventDefault(); document.getElementById('col-'+cn).classList.remove('drag-over');
    try {
        const d = JSON.parse(e.dataTransfer.getData("text/plain"));
        if(d.source==='deck') {
            const k=`${d.set}_${d.id}`;
            if(myDeck[k]) {
                myDeck[k].count--; if(myDeck[k].count<=0) delete myDeck[k];
                const info = LOCAL_DATABASE[d.set].deck.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].leaders.find(x=>x.id==d.id) || LOCAL_DATABASE[d.set].bases.find(x=>x.id==d.id);
                if(info) currentView.push({...info, uid:Date.now(), column:cn});
                renderBoard(); updateSidebar();
            }
        } else if(d.source==='board') {
            const i = currentView.findIndex(c => c.id===d.id && c.set===d.set);
            if(i!==-1) { currentView[i].column=cn; renderBoard(); }
        }
    } catch(e){}
}

function copyJSON() { 
    const d={metadata:{name:"Draft Deck",author:"SWU Drafter"},leader:null,base:null,deck:[],sideboard:[]};
    Object.values(myDeck).forEach(c=>{ 
        const pid = `${c.set.toUpperCase()}_${c.id}`;
        const entry = {id: pid, count: c.count}; 
        if(c.type==='Leader') { d.leader = entry; } 
        else if(c.type==='Base') { d.base = entry; } 
        else d.deck.push(entry); 
    });
    const el=document.createElement('textarea'); el.value=JSON.stringify(d,null,2); 
    document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); 
    playAudio('snd-copy'); 
    const t = document.getElementById('toast'); t.innerText = "JSON COPIED!";
    t.className = 'show'; setTimeout(()=>t.className='', 2000);
}

// --- SAVE / LOAD FUNCTIONALITY ---
function saveDeck() {
    if (Object.keys(myDeck).length === 0) { alert("Deck is empty!"); return; }
    localStorage.setItem('SWU_SAVED_DECK', JSON.stringify(myDeck));
    const t = document.getElementById('toast'); t.innerText = "DECK SAVED!";
    t.className = 'show'; setTimeout(()=>t.className='', 2000);
}

function loadDeck() {
    const saved = localStorage.getItem('SWU_SAVED_DECK');
    if (!saved) { alert("No saved deck found!"); return; }
    if (Object.keys(myDeck).length > 0 && !confirm("Overwrite current deck?")) return;
    
    try {
        myDeck = JSON.parse(saved);
        renderBoard(); // Refresh view
        updateSidebar(); // Refresh list
        const t = document.getElementById('toast'); t.innerText = "DECK LOADED!";
        t.className = 'show'; setTimeout(()=>t.className='', 2000);
    } catch(e) {
        alert("Error loading deck.");
    }
}

const tip = document.getElementById('preview-tooltip');
let isP = false, isT = false;
function showPreview(e,src,t) { isP=true; tip.innerHTML=`<img src="${src}">`; tip.className=t==='Leader'||t==='Base'?'big-preview':''; tip.style.display='block'; reqUpd(e); }
function movePreview(e) { if(isP) reqUpd(e); }
function hidePreview() { isP=false; tip.style.display='none'; }
function reqUpd(e) { if(!isT) { requestAnimationFrame(()=>{ updPos(e); isT=false; }); isT=true; } }
function updPos(e) {
    const w=window.innerWidth, h=window.innerHeight;
    let x=e.clientX+20, y=e.clientY+10;
    const tipW=tip.className.includes('big')?600:320;
    if(x+tipW>w) x=e.clientX-tipW-20;
    if(y+(tip.offsetHeight||400)>h) y=h-(tip.offsetHeight||400)-20;
    tip.style.top=y+'px'; tip.style.left=x+'px';
}

const modal=document.getElementById('modal'), mImg=document.getElementById('modal-img'), mBtn=document.getElementById('modal-flip-btn');
let zC=null;
function openModal(c) { zC=c; modal.style.display='flex'; mImg.src=c.img; mBtn.style.display=c.type==='Leader'?'block':'none'; }
function flipLeader(e) { if(e)e.stopPropagation(); if(!zC||zC.type!=='Leader')return; const b=mImg.src.includes("-back"); mImg.src=b?zC.img:zC.back; }
function closeModal() { modal.style.display='none'; }
</script>
</body>
</html>
